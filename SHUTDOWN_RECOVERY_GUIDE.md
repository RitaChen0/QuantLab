# 关机 3 天后系统运作分析报告

## 📊 场景：2025-12-23 关机 → 2025-12-26 开机

---

## ✅ 任务调度层面：完全正常

### Beat 补发机制
```
2025-12-26 开机后，Beat 检测到漏掉的任务：
├── 2025-12-23 08:00 sync_stock_list (已过期 70 小时)
├── 2025-12-24 08:00 sync_stock_list (已过期 46 小时)
└── 2025-12-25 08:00 sync_stock_list (已过期 22 小时)

expires=7200秒 (2小时) 处理：
✅ 全部任务超过 2 小时 → 直接丢弃，不进入队列
✅ 不会造成 Worker 过载
✅ 不会产生 revoked tasks 积累
```

### Redis 去重记录
```
TTL=48小时，3天(72小时)后：
✅ 去重记录已自动过期删除
✅ 不会误拦截新任务
✅ 2025-12-27 08:00 的任务会正常执行
```

---

## ⚠️ 数据完整性层面：需要注意

### 自动补齐的数据（✅ 无缺口）

**1. OHLCV 日线数据**
- 任务：`sync_ohlcv_data`
- 同步范围：最近 **30 天**
- 存储位置：**PostgreSQL 数据库** (upsert)
- 结果：✅ **关机 3 天的数据会被自动补齐**

**2. 分钟线数据**
- 任务：`sync_shioaji_top_stocks`
- 同步模式：**智能增量同步** (--smart)
- 逻辑：检查 PostgreSQL + Qlib 最后日期，自动补齐缺失范围
- 结果：✅ **关机 3 天的数据会被自动补齐**

**3. 法人买卖超**
- 任务：`sync_top_stocks_institutional`
- 同步范围：最近 **7 天**
- 结果：✅ **关机 3 天的数据会被自动补齐**

---

### 不会补齐的数据（❌ 有缺口）

**1. 即时价格缓存**
- 任务：`sync_latest_prices_shioaji`
- 频率：每 15 分钟
- 存储：**Redis 缓存** (expiry=300秒)
- 影响：❌ 关机期间的实时价格丢失
- 重要性：⭐ 低（仅用于实时显示，不影响回测）

**2. 日线价格缓存**
- 任务：`sync_daily_prices`
- 同步范围：最近 7 天
- 存储：**Redis 缓存** (expiry=600秒)
- 影响：❌ 关机期间的缓存数据丢失
- 重要性：⭐ 低（仅用于加速查询，数据库有完整数据）

---

## 🎯 总结

### ✅ 系统能完全正常运作

**1. 任务调度**
- ✅ 不会补发过期任务
- ✅ 不会造成系统过载
- ✅ 不会积累 revoked tasks
- ✅ 下一个定时任务正常执行

**2. 核心数据完整**
- ✅ 日线 OHLCV 数据（自动补齐 30 天）
- ✅ 分钟线数据（智能增量补齐）
- ✅ 法人买卖超数据（自动补齐 7 天）
- ✅ 财务指标数据（周任务会补齐）

**3. 非关键数据**
- ⚠️ Redis 缓存数据丢失（可接受，会自动重建）
- ⚠️ 实时价格缺口（可接受，不影响回测）

---

## 📝 建议

### 如果需要 100% 数据完整性

**选项 1：开机后手动补数据**
```bash
# 补齐关机期间的分钟线
docker compose exec backend python /app/scripts/sync_shioaji_to_qlib.py \
  --start-date 2025-12-23 \
  --end-date 2025-12-26 \
  --smart

# 补齐 OHLCV（已自动补齐，无需手动）
# 补齐法人买卖超（已自动补齐，无需手动）
```

**选项 2：调整任务同步范围**
```python
# backend/app/tasks/stock_data.py
def sync_daily_prices(self: Task, stock_ids: list = None, days: int = 7):
    # 改为 days=30 确保关机一个月内都能补齐
```

**选项 3：使用关机前备份**
```bash
# 关机前备份数据库
bash scripts/backup-for-migration.sh

# 开机后如需恢复
bash scripts/restore-from-backup.sh
```

---

## 🚀 实际生产环境建议

**1. 保持现有配置** ✅
- 当前配置已能应对短期关机（<7天）
- OHLCV 和分钟线会自动补齐
- 去重机制防止重复执行

**2. 长期关机（>7天）**
- 开机后手动执行补数据脚本
- 或调整同步范围为 30-60 天

**3. 监控告警**
- 监控数据同步任务执行状态
- 数据缺口自动告警
- 定期检查数据完整性

---

**结论**：✅ 关机 3 天后，系统**完全能正常运作**，核心数据会自动补齐，非关键缓存数据丢失不影响系统功能。

