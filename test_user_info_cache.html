<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦ useUserInfo å¿«å–æ©Ÿåˆ¶</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #666;
            font-size: 18px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
        }
        .error {
            border-left-color: #dc3545;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª useUserInfo å¿«å–æ©Ÿåˆ¶æ¸¬è©¦</h1>

    <div class="test-section">
        <h2>1. æª¢æŸ¥ localStorage å¿«å–</h2>
        <button onclick="checkCache()">æª¢æŸ¥å¿«å–</button>
        <button onclick="clearCache()">æ¸…é™¤å¿«å–</button>
        <div id="cache-result"></div>
    </div>

    <div class="test-section">
        <h2>2. æ¨¡æ“¬å¿«å–å­˜å„²</h2>
        <button onclick="simulateCache()">å»ºç«‹æ¸¬è©¦å¿«å–</button>
        <button onclick="simulateExpiredCache()">å»ºç«‹éæœŸå¿«å–</button>
        <div id="simulate-result"></div>
    </div>

    <div class="test-section">
        <h2>3. æ¸¬è©¦å¿«å–è®€å–é‚è¼¯</h2>
        <button onclick="testCacheRead()">æ¸¬è©¦è®€å–</button>
        <div id="read-result"></div>
    </div>

    <div class="test-section">
        <h2>4. é‚Šç•Œæƒ…æ³æ¸¬è©¦</h2>
        <button onclick="testEdgeCases()">åŸ·è¡Œé‚Šç•Œæ¸¬è©¦</button>
        <div id="edge-result"></div>
    </div>

    <script>
        const CACHE_KEY = 'user_info_cache';
        const CACHE_EXPIRY_MS = 5 * 60 * 1000; // 5 åˆ†é˜

        function checkCache() {
            const cached = localStorage.getItem(CACHE_KEY);
            const resultDiv = document.getElementById('cache-result');

            if (!cached) {
                resultDiv.innerHTML = '<div class="result">å¿«å–ä¸å­˜åœ¨</div>';
                return;
            }

            try {
                const data = JSON.parse(cached);
                const now = Date.now();
                const age = now - data.timestamp;
                const ageMinutes = Math.floor(age / 60000);
                const isExpired = age > CACHE_EXPIRY_MS;

                resultDiv.innerHTML = `
                    <div class="result ${isExpired ? 'error' : 'success'}">
                        <strong>å¿«å–è³‡è¨Šï¼š</strong><br>
                        ç”¨æˆ¶å: ${data.username}<br>
                        å…¨å: ${data.fullName}<br>
                        å»ºç«‹æ™‚é–“: ${new Date(data.timestamp).toLocaleString('zh-TW')}<br>
                        å¿«å–å¹´é½¡: ${ageMinutes} åˆ†é˜<br>
                        ç‹€æ…‹: ${isExpired ? 'å·²éæœŸ âš ï¸' : 'æœ‰æ•ˆ âœ…'}
                    </div>
                `;
            } catch (err) {
                resultDiv.innerHTML = `<div class="result error">è§£æå¿«å–å¤±æ•—: ${err.message}</div>`;
            }
        }

        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
            document.getElementById('cache-result').innerHTML =
                '<div class="result success">å¿«å–å·²æ¸…é™¤ âœ…</div>';
        }

        function simulateCache() {
            const data = {
                username: 'testuser',
                fullName: 'æ¸¬è©¦ç”¨æˆ¶',
                timestamp: Date.now()
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            document.getElementById('simulate-result').innerHTML =
                '<div class="result success">æ¸¬è©¦å¿«å–å·²å»ºç«‹ï¼ˆ5 åˆ†é˜æœ‰æ•ˆæœŸï¼‰ âœ…</div>';
        }

        function simulateExpiredCache() {
            const data = {
                username: 'expireduser',
                fullName: 'éæœŸç”¨æˆ¶',
                timestamp: Date.now() - (6 * 60 * 1000) // 6 åˆ†é˜å‰
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            document.getElementById('simulate-result').innerHTML =
                '<div class="result error">éæœŸå¿«å–å·²å»ºç«‹ï¼ˆ6 åˆ†é˜å‰ï¼‰ âš ï¸</div>';
        }

        function testCacheRead() {
            const cached = localStorage.getItem(CACHE_KEY);
            const resultDiv = document.getElementById('read-result');

            if (!cached) {
                resultDiv.innerHTML = '<div class="result error">ç„¡å¿«å–å¯è®€å–</div>';
                return;
            }

            try {
                const data = JSON.parse(cached);
                const now = Date.now();
                const isExpired = (now - data.timestamp) > CACHE_EXPIRY_MS;

                if (isExpired) {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <strong>å¿«å–å·²éæœŸ</strong><br>
                            æ‡‰è©²è§¸ç™¼ API èª¿ç”¨ä»¥ç²å–æ–°æ•¸æ“š
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <strong>å¿«å–æœ‰æ•ˆ</strong><br>
                            å¯ä»¥ä½¿ç”¨å¿«å–æ•¸æ“šï¼š<br>
                            username = "${data.username}"<br>
                            fullName = "${data.fullName}"
                        </div>
                    `;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="result error">è®€å–å¤±æ•—: ${err.message}</div>`;
            }
        }

        function testEdgeCases() {
            const resultDiv = document.getElementById('edge-result');
            const results = [];

            // æ¸¬è©¦ 1: ç©ºå¿«å–
            localStorage.removeItem(CACHE_KEY);
            const test1 = !localStorage.getItem(CACHE_KEY);
            results.push(`ç©ºå¿«å–æª¢æ¸¬: ${test1 ? 'âœ…' : 'âŒ'}`);

            // æ¸¬è©¦ 2: ç„¡æ•ˆ JSON
            localStorage.setItem(CACHE_KEY, 'invalid json');
            try {
                JSON.parse(localStorage.getItem(CACHE_KEY));
                results.push('ç„¡æ•ˆ JSON è™•ç†: âŒï¼ˆæ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ï¼‰');
            } catch {
                results.push('ç„¡æ•ˆ JSON è™•ç†: âœ…ï¼ˆæ­£ç¢ºæ•ç²éŒ¯èª¤ï¼‰');
            }

            // æ¸¬è©¦ 3: ç¼ºå°‘æ¬„ä½
            localStorage.setItem(CACHE_KEY, JSON.stringify({ username: 'test' }));
            const test3Data = JSON.parse(localStorage.getItem(CACHE_KEY));
            results.push(`ç¼ºå°‘ timestamp: ${!test3Data.timestamp ? 'âœ… æª¢æ¸¬åˆ°' : 'âŒ'}`);

            // æ¸¬è©¦ 4: æœªä¾†æ™‚é–“æˆ³ï¼ˆæ™‚é˜åç§»ï¼‰
            const futureData = {
                username: 'future',
                fullName: 'Future User',
                timestamp: Date.now() + 10000
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(futureData));
            const age = Date.now() - futureData.timestamp;
            results.push(`æœªä¾†æ™‚é–“æˆ³è™•ç†: ${age < 0 ? 'âœ… æª¢æ¸¬åˆ°' : 'âŒ'}`);

            // æ¸…ç†
            localStorage.removeItem(CACHE_KEY);

            resultDiv.innerHTML = `
                <div class="result">
                    <strong>é‚Šç•Œæƒ…æ³æ¸¬è©¦çµæœï¼š</strong><br>
                    ${results.join('<br>')}
                </div>
            `;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', checkCache);
    </script>
</body>
</html>
