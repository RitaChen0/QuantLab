# QuantLab Nginx é…ç½®
# ä½¿ç”¨ IP: 122.116.152.55

# ä¸Šæ¸¸æœå‹™å®šç¾©
upstream frontend {
    server frontend:3000;
}

upstream backend {
    server backend:8000;
}

# HTTP æœå‹™å™¨
server {
    listen 80;
    server_name 122.116.152.55;

    # æ—¥èªŒï¼ˆä½¿ç”¨ ISO 8601 æ™‚é–“æˆ³æ ¼å¼ï¼‰
    access_log /var/log/nginx/quantlab-access.log main_with_time;
    error_log /var/log/nginx/quantlab-error.log;

    # ğŸ”’ å®‰å…¨è¦å‰‡ï¼šæ””æˆªæƒ¡æ„æƒææµé‡
    # é˜»æ­¢ WordPress ç›¸é—œè·¯å¾‘
    location ~* ^/(wp-admin|wp-content|wp-includes|xmlrpc\.php) {
        access_log /var/log/nginx/blocked.log main_with_time;
        return 444;  # ç›´æ¥æ–·é–‹é€£æ¥ï¼Œä¸è¿”å›ä»»ä½•éŸ¿æ‡‰
    }

    # é˜»æ­¢å¸¸è¦‹ PHP å¾Œé–€æƒæ
    location ~* \.(php|phtml|asp|aspx|jsp)$ {
        # å…è¨± /api/ è·¯å¾‘ï¼ˆå¾Œç«¯å¯èƒ½ä½¿ç”¨ï¼‰
        if ($request_uri !~* "^/api/") {
            access_log /var/log/nginx/blocked.log main_with_time;
            return 444;
        }
    }

    # é˜»æ­¢å¯ç–‘çš„æª”æ¡ˆè·¯å¾‘
    location ~* ^/(files|tx1|abcd|ac|nox|htaccess|config|shell|upload|backup|sql|db|dump)\.(php|txt|log|bak|sql|gz|zip)$ {
        access_log /var/log/nginx/blocked.log main_with_time;
        return 444;
    }

    # é˜»æ­¢æ¢æ¸¬å¸¸è¦‹ PHP å¾Œå°è·¯å¾‘ï¼ˆæ’é™¤å‰ç«¯è·¯ç”±ï¼‰
    # åªé˜»æ­¢ .php å¾Œç¶´æˆ–å·²çŸ¥ PHP ç®¡ç†å·¥å…·
    location ~* ^/(phpmyadmin|pma|mysql|myadmin|adminer)(/.*)?$ {
        access_log /var/log/nginx/blocked.log main_with_time;
        return 444;
    }

    # é˜»æ­¢ admin.php ç­‰ PHP å¾Œå°æª”æ¡ˆï¼ˆä½†å…è¨±å‰ç«¯ /admin è·¯ç”±ï¼‰
    location ~* ^/admin\.(php|html|htm)$ {
        access_log /var/log/nginx/blocked.log main_with_time;
        return 444;
    }

    # é˜»æ­¢å¸¸è¦‹æ¼æ´æƒæè·¯å¾‘
    location ~* ^/(\.env|\.git|\.svn|\.htaccess|web\.config) {
        access_log /var/log/nginx/blocked.log main_with_time;
        return 444;
    }

    # é™åˆ¶è«‹æ±‚æ–¹æ³•ï¼ˆåªå…è¨± GET, POST, PUT, DELETE, OPTIONSï¼‰
    if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS|HEAD)$) {
        return 444;
    }

    # å¾Œç«¯ API ä»£ç†
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;

        # æ¨™é ­è¨­ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # è¶…æ™‚è¨­ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # ç·©è¡è¨­ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # WebSocket æ”¯æ´ï¼ˆç”¨æ–¼å¯¦æ™‚é€šçŸ¥ï¼‰
    location /ws/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket è¶…æ™‚
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # å¥åº·æª¢æŸ¥ï¼ˆç¦ç”¨è¨ªå•æ—¥èªŒï¼‰
    location /health {
        proxy_pass http://backend/health;
        proxy_set_header Host $host;
        access_log off;  # å·²ç¦ç”¨ï¼ˆDocker healthcheck æ¯ 30 ç§’ï¼‰
    }

    # Prometheus metricsï¼ˆç¦ç”¨è¨ªå•æ—¥èªŒï¼‰
    location /metrics {
        proxy_pass http://backend/metrics;
        proxy_set_header Host $host;
        access_log off;  # å·²ç¦ç”¨ï¼ˆPrometheus æ¯ 10 ç§’æŠ“å–ï¼‰
    }

    # Swagger æ–‡æª”
    location /docs {
        proxy_pass http://backend/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /redoc {
        proxy_pass http://backend/redoc;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /openapi.json {
        proxy_pass http://backend/openapi.json;
        proxy_set_header Host $host;
    }

    # å‰ç«¯æ‡‰ç”¨ï¼ˆæ‰€æœ‰å…¶ä»–è«‹æ±‚ï¼‰
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;

        # æ¨™é ­è¨­ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Nuxt HMR (Hot Module Replacement) æ”¯æ´
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # è¶…æ™‚è¨­ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # éœæ…‹è³‡æºå¿«å–ï¼ˆé–‹ç™¼ç’°å¢ƒï¼šç¦ç”¨ JS å¿«å–ä»¥ä¾¿å³æ™‚æ›´æ–°ï¼‰
    location ~* \.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # CSS/JS æ–‡ä»¶ï¼šé–‹ç™¼ç’°å¢ƒä¸å¿«å–
    location ~* \.(css|js)$ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    }
}
