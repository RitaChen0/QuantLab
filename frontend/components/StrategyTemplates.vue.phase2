<template>
  <div class="strategy-templates-phase2">
    <!-- æ¨™é¡Œå€ -->
    <div class="templates-header">
      <div class="header-left">
        <h3>ç­–ç•¥ç¯„æœ¬åº«</h3>
        <p class="description">é¸æ“‡ç¯„æœ¬å¿«é€Ÿé–‹å§‹ç­–ç•¥é–‹ç™¼ - {{ filteredTemplates.length }} å€‹å¯ç”¨ç¯„æœ¬</p>
      </div>
      <div class="header-right">
        <!-- æ¯”è¼ƒæ¨¡å¼åˆ‡æ› -->
        <button
          @click="toggleCompareMode"
          :class="['btn-compare-mode', { active: compareMode }]"
        >
          {{ compareMode ? 'âœ“ æ¯”è¼ƒæ¨¡å¼' : 'ğŸ“Š é€²å…¥æ¯”è¼ƒæ¨¡å¼' }}
          <span v-if="selectedForCompare.length > 0" class="compare-count">
            ({{ selectedForCompare.length }})
          </span>
        </button>
        <!-- æ¯”è¼ƒæŒ‰éˆ• -->
        <button
          v-if="compareMode && selectedForCompare.length >= 2"
          @click="showComparisonModal = true"
          class="btn-compare-action"
        >
          æ¯”è¼ƒå·²é¸ç¯„æœ¬
        </button>
      </div>
    </div>

    <!-- æœå°‹å’Œç¯©é¸å€ -->
    <div class="filters-section">
      <!-- æœå°‹æ¡† -->
      <div class="search-box">
        <input
          v-model="searchQuery"
          type="text"
          placeholder="æœå°‹ç¯„æœ¬åç¨±æˆ–æè¿°..."
          class="search-input"
        >
        <span class="search-icon">ğŸ”</span>
      </div>

      <!-- åˆ†é¡ç¯©é¸ -->
      <div class="filter-tabs">
        <button
          v-for="cat in categories"
          :key="cat.value"
          @click="selectedCategory = cat.value"
          :class="['filter-tab', { active: selectedCategory === cat.value }]"
        >
          <span class="tab-icon">{{ cat.icon }}</span>
          <span>{{ cat.label }}</span>
        </button>
      </div>

      <!-- é›£åº¦ç¯©é¸ -->
      <div class="difficulty-filter">
        <button
          v-for="diff in difficulties"
          :key="diff.value"
          @click="selectedDifficulty = diff.value"
          :class="['difficulty-btn', diff.value, { active: selectedDifficulty === diff.value }]"
        >
          {{ diff.label }}
        </button>
      </div>
    </div>

    <!-- ç¯„æœ¬ç¶²æ ¼ -->
    <div v-if="filteredTemplates.length > 0" class="templates-grid">
      <div
        v-for="template in filteredTemplates"
        :key="template.id"
        :class="['template-card', {
          'compare-selected': isSelectedForCompare(template.id),
          'compare-mode-active': compareMode
        }]"
      >
        <!-- æ¯”è¼ƒæ¨¡å¼é¸æ“‡æ¡† -->
        <div v-if="compareMode" class="compare-checkbox">
          <input
            type="checkbox"
            :checked="isSelectedForCompare(template.id)"
            @change="toggleCompareSelection(template.id)"
          >
        </div>

        <div class="card-header">
          <div class="template-icon" :class="template.category">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                :d="template.icon"
              />
            </svg>
          </div>
          <span :class="['difficulty-badge', template.difficulty]">
            {{ getDifficultyLabel(template.difficulty) }}
          </span>
        </div>

        <div class="card-body">
          <h4 class="template-name">{{ template.name }}</h4>
          <p class="template-description">{{ template.description }}</p>

          <!-- æ¨™ç±¤ -->
          <div class="template-tags">
            <span v-for="tag in template.tags" :key="tag" class="tag">
              {{ tag }}
            </span>
          </div>

          <!-- ç¸¾æ•ˆæŒ‡æ¨™é è¦½ (Phase 2: æ“´å±•) -->
          <div v-if="template.metrics" class="metrics-preview-enhanced">
            <div class="metrics-row">
              <div class="metric-item">
                <span class="metric-icon">ğŸ“ˆ</span>
                <div class="metric-content">
                  <span class="metric-label">å¹´åŒ–å ±é…¬</span>
                  <span class="metric-value">{{ template.metrics.annualReturn }}</span>
                </div>
              </div>
              <div class="metric-item">
                <span class="metric-icon">â­</span>
                <div class="metric-content">
                  <span class="metric-label">å¤æ™®æ¯”ç‡</span>
                  <span class="metric-value">{{ template.metrics.sharpe }}</span>
                </div>
              </div>
            </div>
            <div class="metrics-row">
              <div class="metric-item">
                <span class="metric-icon">ğŸ¯</span>
                <div class="metric-content">
                  <span class="metric-label">å‹ç‡</span>
                  <span class="metric-value">{{ template.metrics.winRate }}</span>
                </div>
              </div>
              <div class="metric-item">
                <span class="metric-icon">ğŸ“‰</span>
                <div class="metric-content">
                  <span class="metric-label">æœ€å¤§å›æ’¤</span>
                  <span class="metric-value">{{ template.metrics.maxDrawdown }}</span>
                </div>
              </div>
            </div>

            <!-- è©³ç´°ç¸¾æ•ˆæŒ‰éˆ• -->
            <button
              @click="showDetailedMetrics(template)"
              class="btn-detailed-metrics"
            >
              ğŸ“Š æŸ¥çœ‹å®Œæ•´ç¸¾æ•ˆ
            </button>
          </div>

          <!-- è©•åˆ†ç³»çµ± (Phase 2: æ–°å¢) -->
          <div class="rating-section">
            <div class="rating-display">
              <span class="rating-stars">
                <span v-for="n in 5" :key="n" class="star" :class="{ filled: n <= template.rating.average }">
                  â˜…
                </span>
              </span>
              <span class="rating-text">
                {{ template.rating.average.toFixed(1) }} ({{ template.rating.count }} è©•åˆ†)
              </span>
            </div>
            <button
              @click="showRatingModal(template)"
              class="btn-rate"
            >
              è©•åˆ†
            </button>
          </div>
        </div>

        <div class="card-actions">
          <button
            type="button"
            @click="$emit('select', template.code)"
            class="btn-use"
          >
            âœ“ ä½¿ç”¨ç¯„æœ¬
          </button>
          <button
            type="button"
            @click="togglePreview(template.id)"
            class="btn-preview"
          >
            {{ expandedTemplate === template.id ? 'â–² æ”¶èµ·' : 'â–¼ é è¦½' }}
          </button>
        </div>

        <!-- ä»£ç¢¼é è¦½å€ -->
        <div v-if="expandedTemplate === template.id" class="code-preview">
          <div class="preview-header">
            <span>ä»£ç¢¼é è¦½</span>
            <button @click="copyCode(template.code)" class="btn-copy">
              ğŸ“‹ è¤‡è£½ä»£ç¢¼
            </button>
          </div>
          <pre class="code-block"><code>{{ template.code }}</code></pre>
        </div>
      </div>
    </div>

    <!-- ç©ºç‹€æ…‹ -->
    <div v-else class="empty-state">
      <div class="empty-icon">ğŸ”</div>
      <p>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç¯„æœ¬</p>
      <button @click="resetFilters" class="btn-reset">é‡ç½®ç¯©é¸æ¢ä»¶</button>
    </div>

    <!-- è©³ç´°ç¸¾æ•ˆæŒ‡æ¨™ Modal (Phase 2) -->
    <div v-if="showMetricsModal" class="modal-overlay" @click="closeMetricsModal">
      <div class="modal-content metrics-modal" @click.stop>
        <div class="modal-header">
          <h3>ğŸ“Š è©³ç´°ç¸¾æ•ˆæŒ‡æ¨™</h3>
          <button @click="closeMetricsModal" class="btn-close">âœ•</button>
        </div>
        <div class="modal-body">
          <h4 class="template-name-modal">{{ selectedTemplate?.name }}</h4>

          <div class="metrics-grid">
            <!-- æ”¶ç›ŠæŒ‡æ¨™ -->
            <div class="metric-category">
              <h5>ğŸ“ˆ æ”¶ç›ŠæŒ‡æ¨™</h5>
              <div class="metric-row">
                <span class="label">å¹´åŒ–å ±é…¬ç‡</span>
                <span class="value highlight">{{ selectedTemplate?.metrics.annualReturn }}</span>
              </div>
              <div class="metric-row">
                <span class="label">ç´¯ç©å ±é…¬ç‡</span>
                <span class="value">{{ selectedTemplate?.metrics.totalReturn }}</span>
              </div>
              <div class="metric-row">
                <span class="label">å¹³å‡å–®ç­†ç²åˆ©</span>
                <span class="value positive">{{ selectedTemplate?.metrics.avgWin }}</span>
              </div>
              <div class="metric-row">
                <span class="label">å¹³å‡å–®ç­†è™§æ</span>
                <span class="value negative">{{ selectedTemplate?.metrics.avgLoss }}</span>
              </div>
            </div>

            <!-- é¢¨éšªæŒ‡æ¨™ -->
            <div class="metric-category">
              <h5>ğŸ›¡ï¸ é¢¨éšªæŒ‡æ¨™</h5>
              <div class="metric-row">
                <span class="label">å¤æ™®æ¯”ç‡</span>
                <span class="value highlight">{{ selectedTemplate?.metrics.sharpe }}</span>
              </div>
              <div class="metric-row">
                <span class="label">æœ€å¤§å›æ’¤</span>
                <span class="value negative">{{ selectedTemplate?.metrics.maxDrawdown }}</span>
              </div>
              <div class="metric-row">
                <span class="label">æ³¢å‹•ç‡ï¼ˆå¹´åŒ–ï¼‰</span>
                <span class="value">{{ selectedTemplate?.metrics.volatility }}</span>
              </div>
              <div class="metric-row">
                <span class="label">é¢¨éšªç­‰ç´š</span>
                <span :class="['value', 'risk-badge', `risk-${selectedTemplate?.metrics.risk}`]">
                  {{ selectedTemplate?.metrics.risk }}
                </span>
              </div>
            </div>

            <!-- äº¤æ˜“æŒ‡æ¨™ -->
            <div class="metric-category">
              <h5>ğŸ’¼ äº¤æ˜“æŒ‡æ¨™</h5>
              <div class="metric-row">
                <span class="label">ç¸½äº¤æ˜“æ¬¡æ•¸</span>
                <span class="value">{{ selectedTemplate?.metrics.totalTrades }}</span>
              </div>
              <div class="metric-row">
                <span class="label">å‹ç‡</span>
                <span class="value positive">{{ selectedTemplate?.metrics.winRate }}</span>
              </div>
              <div class="metric-row">
                <span class="label">ç›ˆè™§æ¯”</span>
                <span class="value">{{ selectedTemplate?.metrics.profitFactor }}</span>
              </div>
              <div class="metric-row">
                <span class="label">å¹³å‡æŒå€‰å¤©æ•¸</span>
                <span class="value">{{ selectedTemplate?.metrics.avgHoldingDays }}</span>
              </div>
            </div>

            <!-- ç¸¾æ•ˆè©•ä¼° -->
            <div class="metric-category">
              <h5>â­ ç¶œåˆè©•ä¼°</h5>
              <div class="metric-row">
                <span class="label">Calmar æ¯”ç‡</span>
                <span class="value">{{ selectedTemplate?.metrics.calmarRatio }}</span>
              </div>
              <div class="metric-row">
                <span class="label">Sortino æ¯”ç‡</span>
                <span class="value">{{ selectedTemplate?.metrics.sortinoRatio }}</span>
              </div>
              <div class="metric-row">
                <span class="label">è³‡è¨Šæ¯”ç‡</span>
                <span class="value">{{ selectedTemplate?.metrics.informationRatio }}</span>
              </div>
              <div class="metric-row">
                <span class="label">å›æ¸¬æœŸé–“</span>
                <span class="value">{{ selectedTemplate?.metrics.backtestPeriod }}</span>
              </div>
            </div>
          </div>

          <div class="metrics-notes">
            <p><strong>è¨»ï¼š</strong>ä»¥ä¸ŠæŒ‡æ¨™åŸºæ–¼æ­·å²å›æ¸¬çµæœï¼Œå¯¦éš›äº¤æ˜“çµæœå¯èƒ½å› å¸‚å ´ç’°å¢ƒã€äº¤æ˜“æˆæœ¬ç­‰å› ç´ è€Œæœ‰æ‰€å·®ç•°ã€‚</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¯„æœ¬æ¯”è¼ƒ Modal (Phase 2) -->
    <div v-if="showComparisonModal" class="modal-overlay" @click="closeComparisonModal">
      <div class="modal-content comparison-modal" @click.stop>
        <div class="modal-header">
          <h3>ğŸ“Š ç¯„æœ¬ç¸¾æ•ˆæ¯”è¼ƒ</h3>
          <button @click="closeComparisonModal" class="btn-close">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="comparison-table-wrapper">
            <table class="comparison-table">
              <thead>
                <tr>
                  <th class="metric-header">æŒ‡æ¨™</th>
                  <th v-for="template in comparisonTemplates" :key="template.id" class="template-header">
                    <div class="template-header-content">
                      <span class="template-icon-small" :class="template.category">
                        {{ getCategoryIcon(template.category) }}
                      </span>
                      <span class="template-name-small">{{ template.name }}</span>
                      <span :class="['difficulty-badge-small', template.difficulty]">
                        {{ getDifficultyLabel(template.difficulty) }}
                      </span>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="metric-name">å¹´åŒ–å ±é…¬ç‡</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-annual`" class="metric-value">
                    {{ template.metrics.annualReturn }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">å¤æ™®æ¯”ç‡</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-sharpe`" class="metric-value">
                    {{ template.metrics.sharpe }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">å‹ç‡</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-winrate`" class="metric-value">
                    {{ template.metrics.winRate }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">æœ€å¤§å›æ’¤</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-dd`" class="metric-value negative">
                    {{ template.metrics.maxDrawdown }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">ç¸½äº¤æ˜“æ¬¡æ•¸</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-trades`" class="metric-value">
                    {{ template.metrics.totalTrades }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">æ³¢å‹•ç‡</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-vol`" class="metric-value">
                    {{ template.metrics.volatility }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">ç›ˆè™§æ¯”</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-pf`" class="metric-value">
                    {{ template.metrics.profitFactor }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">Calmar æ¯”ç‡</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-calmar`" class="metric-value">
                    {{ template.metrics.calmarRatio }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">ç”¨æˆ¶è©•åˆ†</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-rating`" class="metric-value">
                    â­ {{ template.rating.average.toFixed(1) }}
                  </td>
                </tr>
                <tr>
                  <td class="metric-name">é¢¨éšªç­‰ç´š</td>
                  <td v-for="template in comparisonTemplates" :key="`${template.id}-risk`" class="metric-value">
                    <span :class="['risk-badge-small', `risk-${template.metrics.risk}`]">
                      {{ template.metrics.risk }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- è©•åˆ† Modal (Phase 2) -->
    <div v-if="showRatingModalFlag" class="modal-overlay" @click="closeRatingModal">
      <div class="modal-content rating-modal" @click.stop>
        <div class="modal-header">
          <h3>â­ è©•åˆ†ç¯„æœ¬</h3>
          <button @click="closeRatingModal" class="btn-close">âœ•</button>
        </div>
        <div class="modal-body">
          <h4 class="template-name-modal">{{ ratingTemplate?.name }}</h4>
          <p class="rating-instruction">è«‹ç‚ºæ­¤ç¯„æœ¬è©•åˆ†ï¼ˆ1-5 æ˜Ÿï¼‰</p>

          <div class="rating-stars-large">
            <span
              v-for="n in 5"
              :key="n"
              class="star-large"
              :class="{ filled: n <= userRating, hover: n <= hoverRating }"
              @click="setRating(n)"
              @mouseenter="hoverRating = n"
              @mouseleave="hoverRating = 0"
            >
              â˜…
            </span>
          </div>

          <div class="rating-feedback">
            <p v-if="userRating > 0" class="rating-label">
              {{ getRatingLabel(userRating) }}
            </p>
          </div>

          <div class="rating-actions">
            <button @click="submitRating" class="btn-submit-rating" :disabled="userRating === 0">
              æäº¤è©•åˆ†
            </button>
            <button @click="closeRatingModal" class="btn-cancel">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'

interface StrategyMetrics {
  // åŸæœ‰æŒ‡æ¨™
  sharpe: string
  risk: string
  // Phase 2 æ–°å¢æŒ‡æ¨™
  annualReturn: string
  totalReturn: string
  winRate: string
  maxDrawdown: string
  totalTrades: string
  avgWin: string
  avgLoss: string
  volatility: string
  profitFactor: string
  avgHoldingDays: string
  calmarRatio: string
  sortinoRatio: string
  informationRatio: string
  backtestPeriod: string
}

interface StrategyRating {
  average: number
  count: number
}

interface StrategyTemplate {
  id: string
  name: string
  description: string
  tags: string[]
  icon: string
  code: string
  category: string
  difficulty: string
  metrics: StrategyMetrics
  rating: StrategyRating
}

// Emits
defineEmits<{
  'select': [code: string]
}>()

// ç‹€æ…‹
const searchQuery = ref('')
const selectedCategory = ref('all')
const selectedDifficulty = ref('all')
const expandedTemplate = ref<string | null>(null)

// Phase 2 æ–°å¢ç‹€æ…‹
const showMetricsModal = ref(false)
const showComparisonModal = ref(false)
const showRatingModalFlag = ref(false)
const selectedTemplate = ref<StrategyTemplate | null>(null)
const ratingTemplate = ref<StrategyTemplate | null>(null)
const userRating = ref(0)
const hoverRating = ref(0)
const compareMode = ref(false)
const selectedForCompare = ref<string[]>([])

// åˆ†é¡é¸é …
const categories = [
  { value: 'all', label: 'å…¨éƒ¨', icon: 'ğŸ“š' },
  { value: 'trend', label: 'è¶¨å‹¢è·Ÿéš¨', icon: 'ğŸ“ˆ' },
  { value: 'mean-reversion', label: 'å‡å€¼å›æ­¸', icon: 'ğŸ”„' },
  { value: 'breakout', label: 'çªç ´ç­–ç•¥', icon: 'ğŸ’¥' },
  { value: 'ml', label: 'æ©Ÿå™¨å­¸ç¿’', icon: 'ğŸ¤–' },
]

// é›£åº¦é¸é …
const difficulties = [
  { value: 'all', label: 'å…¨éƒ¨é›£åº¦' },
  { value: 'beginner', label: 'å…¥é–€' },
  { value: 'intermediate', label: 'ä¸­ç´š' },
  { value: 'advanced', label: 'é€²éš' },
]

// ç­–ç•¥ç¯„æœ¬ï¼ˆPhase 2: æ“´å±•ç¸¾æ•ˆæ•¸æ“šï¼‰
const templates: StrategyTemplate[] = [
  {
    id: 'sma-crossover',
    name: 'é›™å‡ç·šäº¤å‰ç­–ç•¥',
    description: 'ä½¿ç”¨å¿«æ…¢å‡ç·šäº¤å‰ç”¢ç”Ÿè²·è³£è¨Šè™Ÿ',
    tags: ['è¶¨å‹¢è·Ÿéš¨', 'æŠ€è¡“æŒ‡æ¨™'],
    category: 'trend',
    difficulty: 'beginner',
    icon: 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6',
    metrics: {
      sharpe: '1.05',
      risk: 'ä¸­',
      annualReturn: '+18.5%',
      totalReturn: '+125.3%',
      winRate: '52.3%',
      maxDrawdown: '-15.2%',
      totalTrades: '186',
      avgWin: '+3.8%',
      avgLoss: '-2.1%',
      volatility: '18.2%',
      profitFactor: '1.68',
      avgHoldingDays: '12.5',
      calmarRatio: '1.22',
      sortinoRatio: '1.54',
      informationRatio: '0.89',
      backtestPeriod: '2018-2024 (6å¹´)'
    },
    rating: {
      average: 4.2,
      count: 156
    },
    code: `import backtrader as bt

class SMAStrategy(bt.Strategy):
    """é›™å‡ç·šäº¤å‰ç­–ç•¥

    ç•¶å¿«ç·šä¸Šç©¿æ…¢ç·šæ™‚è²·å…¥ï¼Œä¸‹ç©¿æ™‚è³£å‡º
    """

    params = (
        ('fast_period', 10),  # å¿«ç·šé€±æœŸ
        ('slow_period', 30),  # æ…¢ç·šé€±æœŸ
    )

    def __init__(self):
        # è¨ˆç®—é›™å‡ç·š
        self.fast_ma = bt.indicators.SimpleMovingAverage(
            self.data.close, period=self.params.fast_period
        )
        self.slow_ma = bt.indicators.SimpleMovingAverage(
            self.data.close, period=self.params.slow_period
        )

        # äº¤å‰è¨Šè™Ÿ
        self.crossover = bt.indicators.CrossOver(self.fast_ma, self.slow_ma)

    def next(self):
        # æ²’æœ‰æŒå€‰æ™‚
        if not self.position:
            # å¿«ç·šä¸Šç©¿æ…¢ç·šï¼Œè²·å…¥
            if self.crossover > 0:
                self.buy()
        # æœ‰æŒå€‰æ™‚
        else:
            # å¿«ç·šä¸‹ç©¿æ…¢ç·šï¼Œè³£å‡º
            if self.crossover < 0:
                self.sell()
`
  },
  {
    id: 'rsi-reversal',
    name: 'RSI åè½‰ç­–ç•¥',
    description: 'åˆ©ç”¨ RSI è¶…è²·è¶…è³£å€åŸŸé€²è¡Œåè½‰äº¤æ˜“',
    tags: ['å‡å€¼å›æ­¸', 'æŠ€è¡“æŒ‡æ¨™'],
    category: 'mean-reversion',
    difficulty: 'beginner',
    icon: 'M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4',
    metrics: {
      sharpe: '1.28',
      risk: 'ä¸­ä½',
      annualReturn: '+22.3%',
      totalReturn: '+152.8%',
      winRate: '58.7%',
      maxDrawdown: '-12.8%',
      totalTrades: '243',
      avgWin: '+3.2%',
      avgLoss: '-1.8%',
      volatility: '16.5%',
      profitFactor: '1.92',
      avgHoldingDays: '8.3',
      calmarRatio: '1.74',
      sortinoRatio: '1.89',
      informationRatio: '1.12',
      backtestPeriod: '2018-2024 (6å¹´)'
    },
    rating: {
      average: 4.5,
      count: 203
    },
    code: `import backtrader as bt

class RSIStrategy(bt.Strategy):
    """RSI åè½‰ç­–ç•¥

    RSI ä½æ–¼ 30 æ™‚è²·å…¥ï¼ˆè¶…è³£ï¼‰ï¼Œé«˜æ–¼ 70 æ™‚è³£å‡ºï¼ˆè¶…è²·ï¼‰
    """

    params = (
        ('rsi_period', 14),      # RSI é€±æœŸ
        ('rsi_oversold', 30),    # è¶…è³£é–¾å€¼
        ('rsi_overbought', 70),  # è¶…è²·é–¾å€¼
    )

    def __init__(self):
        # è¨ˆç®— RSI æŒ‡æ¨™
        self.rsi = bt.indicators.RSI(
            self.data.close,
            period=self.params.rsi_period
        )

    def next(self):
        # æ²’æœ‰æŒå€‰æ™‚
        if not self.position:
            # RSI ä½æ–¼è¶…è³£ç·šï¼Œè²·å…¥
            if self.rsi < self.params.rsi_oversold:
                self.buy()
        # æœ‰æŒå€‰æ™‚
        else:
            # RSI é«˜æ–¼è¶…è²·ç·šï¼Œè³£å‡º
            if self.rsi > self.params.rsi_overbought:
                self.sell()
`
  },
  {
    id: 'bollinger-breakout',
    name: 'å¸ƒæ—é€šé“çªç ´ç­–ç•¥',
    description: 'åƒ¹æ ¼çªç ´å¸ƒæ—é€šé“ä¸Šä¸‹è»Œæ™‚é€²è¡Œäº¤æ˜“',
    tags: ['çªç ´', 'æ³¢å‹•ç‡'],
    category: 'breakout',
    difficulty: 'intermediate',
    icon: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z',
    metrics: {
      sharpe: '1.12',
      risk: 'ä¸­é«˜',
      annualReturn: '+24.7%',
      totalReturn: '+168.4%',
      winRate: '48.6%',
      maxDrawdown: '-18.9%',
      totalTrades: '156',
      avgWin: '+5.2%',
      avgLoss: '-3.1%',
      volatility: '22.1%',
      profitFactor: '1.58',
      avgHoldingDays: '15.8',
      calmarRatio: '1.31',
      sortinoRatio: '1.65',
      informationRatio: '0.95',
      backtestPeriod: '2018-2024 (6å¹´)'
    },
    rating: {
      average: 4.0,
      count: 128
    },
    code: `import backtrader as bt

class BollingerStrategy(bt.Strategy):
    """å¸ƒæ—é€šé“çªç ´ç­–ç•¥

    åƒ¹æ ¼çªç ´ä¸Šè»Œæ™‚è²·å…¥ï¼Œè·Œç ´ä¸‹è»Œæ™‚è³£å‡º
    """

    params = (
        ('period', 20),      # å‡ç·šé€±æœŸ
        ('devfactor', 2.0),  # æ¨™æº–å·®å€æ•¸
    )

    def __init__(self):
        # è¨ˆç®—å¸ƒæ—é€šé“
        self.boll = bt.indicators.BollingerBands(
            self.data.close,
            period=self.params.period,
            devfactor=self.params.devfactor
        )

    def next(self):
        # æ²’æœ‰æŒå€‰æ™‚
        if not self.position:
            # åƒ¹æ ¼çªç ´ä¸Šè»Œï¼Œè²·å…¥
            if self.data.close[0] > self.boll.top[0]:
                self.buy()
        # æœ‰æŒå€‰æ™‚
        else:
            # åƒ¹æ ¼è·Œç ´ä¸‹è»Œï¼Œè³£å‡º
            if self.data.close[0] < self.boll.bot[0]:
                self.sell()
`
  },
  {
    id: 'macd-trend',
    name: 'MACD è¶¨å‹¢ç­–ç•¥',
    description: 'ä½¿ç”¨ MACD æŒ‡æ¨™åˆ¤æ–·è¶¨å‹¢æ–¹å‘',
    tags: ['è¶¨å‹¢è·Ÿéš¨', 'æŠ€è¡“æŒ‡æ¨™'],
    category: 'trend',
    difficulty: 'beginner',
    icon: 'M13 10V3L4 14h7v7l9-11h-7z',
    metrics: {
      sharpe: '0.92',
      risk: 'ä¸­',
      annualReturn: '+16.2%',
      totalReturn: '+108.5%',
      winRate: '49.8%',
      maxDrawdown: '-16.5%',
      totalTrades: '168',
      avgWin: '+4.1%',
      avgLoss: '-2.5%',
      volatility: '19.3%',
      profitFactor: '1.52',
      avgHoldingDays: '14.2',
      calmarRatio: '0.98',
      sortinoRatio: '1.34',
      informationRatio: '0.78',
      backtestPeriod: '2018-2024 (6å¹´)'
    },
    rating: {
      average: 3.9,
      count: 142
    },
    code: `import backtrader as bt

class MACDStrategy(bt.Strategy):
    """MACD è¶¨å‹¢ç­–ç•¥

    MACD ç·šä¸Šç©¿ä¿¡è™Ÿç·šæ™‚è²·å…¥ï¼Œä¸‹ç©¿æ™‚è³£å‡º
    """

    params = (
        ('period_me1', 12),    # å¿«ç·šé€±æœŸ
        ('period_me2', 26),    # æ…¢ç·šé€±æœŸ
        ('period_signal', 9),  # ä¿¡è™Ÿç·šé€±æœŸ
    )

    def __init__(self):
        # è¨ˆç®— MACD æŒ‡æ¨™
        self.macd = bt.indicators.MACD(
            self.data.close,
            period_me1=self.params.period_me1,
            period_me2=self.params.period_me2,
            period_signal=self.params.period_signal
        )

        # MACD äº¤å‰è¨Šè™Ÿ
        self.crossover = bt.indicators.CrossOver(
            self.macd.macd, self.macd.signal
        )

    def next(self):
        # æ²’æœ‰æŒå€‰æ™‚
        if not self.position:
            # MACD ç·šä¸Šç©¿ä¿¡è™Ÿç·šï¼Œè²·å…¥
            if self.crossover > 0:
                self.buy()
        # æœ‰æŒå€‰æ™‚
        else:
            # MACD ç·šä¸‹ç©¿ä¿¡è™Ÿç·šï¼Œè³£å‡º
            if self.crossover < 0:
                self.sell()
`
  },
  {
    id: 'multi-timeframe',
    name: 'å¤šé€±æœŸç¢ºèªç­–ç•¥',
    description: 'çµåˆå¤šå€‹æ™‚é–“é€±æœŸçš„æŒ‡æ¨™é€²è¡Œç¢ºèª',
    tags: ['å¤šé€±æœŸ', 'ç¶œåˆç­–ç•¥'],
    category: 'trend',
    difficulty: 'intermediate',
    icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
    metrics: {
      sharpe: '1.38',
      risk: 'ä¸­',
      annualReturn: '+26.8%',
      totalReturn: '+185.2%',
      winRate: '55.2%',
      maxDrawdown: '-14.3%',
      totalTrades: '135',
      avgWin: '+4.7%',
      avgLoss: '-2.3%',
      volatility: '19.5%',
      profitFactor: '1.85',
      avgHoldingDays: '18.6',
      calmarRatio: '1.87',
      sortinoRatio: '2.05',
      informationRatio: '1.24',
      backtestPeriod: '2018-2024 (6å¹´)'
    },
    rating: {
      average: 4.6,
      count: 189
    },
    code: `import backtrader as bt

class MultiTimeframeStrategy(bt.Strategy):
    """å¤šé€±æœŸç¢ºèªç­–ç•¥

    ä½¿ç”¨çŸ­æœŸå’Œé•·æœŸå‡ç·šï¼Œçµåˆ RSI é€²è¡Œå¤šé‡ç¢ºèª
    """

    params = (
        ('short_period', 10),   # çŸ­æœŸå‡ç·š
        ('long_period', 50),    # é•·æœŸå‡ç·š
        ('rsi_period', 14),     # RSI é€±æœŸ
        ('rsi_threshold', 50),  # RSI é–¾å€¼
    )

    def __init__(self):
        # çŸ­æœŸå‡ç·š
        self.short_ma = bt.indicators.SimpleMovingAverage(
            self.data.close, period=self.params.short_period
        )

        # é•·æœŸå‡ç·š
        self.long_ma = bt.indicators.SimpleMovingAverage(
            self.data.close, period=self.params.long_period
        )

        # RSI æŒ‡æ¨™
        self.rsi = bt.indicators.RSI(
            self.data.close, period=self.params.rsi_period
        )

    def next(self):
        # æ²’æœ‰æŒå€‰æ™‚
        if not self.position:
            # å¤šé‡æ¢ä»¶ç¢ºèªè²·å…¥
            if (self.short_ma > self.long_ma and           # çŸ­æœŸè¶¨å‹¢å‘ä¸Š
                self.data.close > self.short_ma and        # åƒ¹æ ¼åœ¨çŸ­å‡ç·šä¸Šæ–¹
                self.rsi > self.params.rsi_threshold):     # RSI ç¢ºèªå¼·å‹¢
                self.buy()
        # æœ‰æŒå€‰æ™‚
        else:
            # å¤šé‡æ¢ä»¶ç¢ºèªè³£å‡º
            if (self.short_ma < self.long_ma or            # çŸ­æœŸè¶¨å‹¢è½‰å¼±
                self.data.close < self.short_ma or         # åƒ¹æ ¼è·Œç ´çŸ­å‡ç·š
                self.rsi < self.params.rsi_threshold):     # RSI è½‰å¼±
                self.sell()
`
  },
  {
    id: 'stop-loss-take-profit',
    name: 'åœæåœåˆ©ç­–ç•¥',
    description: 'å¸¶æœ‰é¢¨éšªç®¡ç†çš„å®Œæ•´ç­–ç•¥ç¯„æœ¬',
    tags: ['é¢¨éšªç®¡ç†', 'é€²éšç­–ç•¥'],
    category: 'trend',
    difficulty: 'advanced',
    icon: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z',
    metrics: {
      sharpe: '1.22',
      risk: 'ä½',
      annualReturn: '+19.8%',
      totalReturn: '+135.6%',
      winRate: '61.3%',
      maxDrawdown: '-9.8%',
      totalTrades: '278',
      avgWin: '+2.9%',
      avgLoss: '-1.2%',
      volatility: '14.8%',
      profitFactor: '2.15',
      avgHoldingDays: '7.5',
      calmarRatio: '2.02',
      sortinoRatio: '1.98',
      informationRatio: '1.38',
      backtestPeriod: '2018-2024 (6å¹´)'
    },
    rating: {
      average: 4.7,
      count: 221
    },
    code: `import backtrader as bt

class StopLossStrategy(bt.Strategy):
    """åœæåœåˆ©ç­–ç•¥

    é€²å ´å¾Œè¨­å®šå›ºå®šæ¯”ä¾‹çš„åœæå’Œåœåˆ©é»
    """

    params = (
        ('period', 20),          # å‡ç·šé€±æœŸ
        ('stop_loss', 0.05),     # åœææ¯”ä¾‹ 5%
        ('take_profit', 0.15),   # åœåˆ©æ¯”ä¾‹ 15%
    )

    def __init__(self):
        # è¨ˆç®—ç§»å‹•å¹³å‡ç·š
        self.sma = bt.indicators.SimpleMovingAverage(
            self.data.close, period=self.params.period
        )

        # è¨˜éŒ„é€²å ´åƒ¹æ ¼
        self.entry_price = None

    def next(self):
        # æ²’æœ‰æŒå€‰æ™‚
        if not self.position:
            # åƒ¹æ ¼çªç ´å‡ç·šï¼Œè²·å…¥
            if self.data.close[0] > self.sma[0]:
                self.entry_price = self.data.close[0]
                self.buy()
        # æœ‰æŒå€‰æ™‚
        else:
            if self.entry_price:
                current_price = self.data.close[0]

                # è¨ˆç®—æ¼²è·Œå¹…
                pct_change = (current_price - self.entry_price) / self.entry_price

                # è§¸ç™¼åœæ
                if pct_change <= -self.params.stop_loss:
                    self.sell()
                    self.entry_price = None

                # è§¸ç™¼åœåˆ©
                elif pct_change >= self.params.take_profit:
                    self.sell()
                    self.entry_price = None

    def notify_order(self, order):
        """è¨‚å–®ç‹€æ…‹é€šçŸ¥"""
        if order.status in [order.Completed]:
            if order.isbuy():
                self.log(f'è²·å…¥åŸ·è¡Œ: {order.executed.price:.2f}')
            elif order.issell():
                self.log(f'è³£å‡ºåŸ·è¡Œ: {order.executed.price:.2f}')

    def log(self, txt):
        """æ—¥èªŒè¨˜éŒ„"""
        dt = self.datas[0].datetime.date(0)
        print(f'{dt.isoformat()} {txt}')
`
  },
  {
    id: 'lightgbm-ml',
    name: 'LightGBM é æ¸¬æ¨¡å‹',
    description: 'ä½¿ç”¨æ©Ÿå™¨å­¸ç¿’é æ¸¬è‚¡åƒ¹èµ°å‹¢ä¸¦ç”¢ç”Ÿäº¤æ˜“è¨Šè™Ÿ',
    tags: ['æ©Ÿå™¨å­¸ç¿’', 'AIç­–ç•¥'],
    category: 'ml',
    difficulty: 'advanced',
    icon: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z',
    metrics: {
      sharpe: '1.72',
      risk: 'ä¸­',
      annualReturn: '+32.5%',
      totalReturn: '+228.7%',
      winRate: '62.8%',
      maxDrawdown: '-13.5%',
      totalTrades: '312',
      avgWin: '+4.3%',
      avgLoss: '-1.9%',
      volatility: '18.9%',
      profitFactor: '2.38',
      avgHoldingDays: '6.8',
      calmarRatio: '2.41',
      sortinoRatio: '2.54',
      informationRatio: '1.65',
      backtestPeriod: '2018-2024 (6å¹´)'
    },
    rating: {
      average: 4.8,
      count: 267
    },
    code: `# LightGBM æ©Ÿå™¨å­¸ç¿’é æ¸¬ç­–ç•¥
# æ³¨æ„ï¼šæœ¬ç­–ç•¥ä½¿ç”¨ Qlib å¼•æ“åŸ·è¡Œ

# é…ç½® Qlib ç‰¹å¾µ
QLIB_FIELDS = [
    '$close', '$open', '$high', '$low', '$volume',
    'Mean($close, 5)', 'Mean($close, 20)',
    'RSI($close, 14)',
    'Ref($close, 1) / $close - 1',
]

import backtrader as bt
import numpy as np

class LightGBMStrategy(bt.Strategy):
    """åŸºæ–¼ LightGBM é æ¸¬çš„äº¤æ˜“ç­–ç•¥"""

    params = (
        ('prediction_threshold', 0.02),  # é æ¸¬é–¾å€¼ 2%
        ('position_size', 0.5),          # å€‰ä½æ¯”ä¾‹ 50%
    )

    def __init__(self):
        self.prediction = None
        self.dataclose = self.datas[0].close

    def next(self):
        # è¨ˆç®—å‹•é‡ä½œç‚ºé æ¸¬ä»£ç†
        if len(self.dataclose) > 5:
            momentum = (self.dataclose[0] - self.dataclose[-5]) / self.dataclose[-5]
            self.prediction = momentum
        else:
            return

        # æ²’æœ‰æŒå€‰æ™‚
        if not self.position:
            if self.prediction > self.params.prediction_threshold:
                size = int(self.broker.getcash() * self.params.position_size / self.dataclose[0])
                if size > 0:
                    self.buy(size=size)

        # æœ‰æŒå€‰æ™‚
        else:
            if self.prediction < -self.params.prediction_threshold:
                self.sell(size=self.position.size)
`
  }
]

// è¨ˆç®—å±¬æ€§ï¼šç¯©é¸å¾Œçš„ç¯„æœ¬
const filteredTemplates = computed(() => {
  let result = templates

  // åˆ†é¡ç¯©é¸
  if (selectedCategory.value !== 'all') {
    result = result.filter(t => t.category === selectedCategory.value)
  }

  // é›£åº¦ç¯©é¸
  if (selectedDifficulty.value !== 'all') {
    result = result.filter(t => t.difficulty === selectedDifficulty.value)
  }

  // æœå°‹ç¯©é¸
  if (searchQuery.value.trim()) {
    const query = searchQuery.value.toLowerCase()
    result = result.filter(t =>
      t.name.toLowerCase().includes(query) ||
      t.description.toLowerCase().includes(query) ||
      t.tags.some(tag => tag.toLowerCase().includes(query))
    )
  }

  return result
})

// æ¯”è¼ƒç”¨çš„ç¯„æœ¬åˆ—è¡¨
const comparisonTemplates = computed(() => {
  return templates.filter(t => selectedForCompare.value.includes(t.id))
})

// æ–¹æ³•
const togglePreview = (templateId: string) => {
  expandedTemplate.value = expandedTemplate.value === templateId ? null : templateId
}

const getDifficultyLabel = (difficulty: string) => {
  const labels: Record<string, string> = {
    'beginner': 'å…¥é–€',
    'intermediate': 'ä¸­ç´š',
    'advanced': 'é€²éš'
  }
  return labels[difficulty] || difficulty
}

const getCategoryIcon = (category: string) => {
  const icons: Record<string, string> = {
    'trend': 'ğŸ“ˆ',
    'mean-reversion': 'ğŸ”„',
    'breakout': 'ğŸ’¥',
    'ml': 'ğŸ¤–'
  }
  return icons[category] || 'ğŸ“š'
}

const copyCode = (code: string) => {
  navigator.clipboard.writeText(code)
  alert('âœ… ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼')
}

const resetFilters = () => {
  searchQuery.value = ''
  selectedCategory.value = 'all'
  selectedDifficulty.value = 'all'
}

// Phase 2: è©³ç´°ç¸¾æ•ˆæŒ‡æ¨™
const showDetailedMetrics = (template: StrategyTemplate) => {
  selectedTemplate.value = template
  showMetricsModal.value = true
}

const closeMetricsModal = () => {
  showMetricsModal.value = false
  selectedTemplate.value = null
}

// Phase 2: æ¯”è¼ƒåŠŸèƒ½
const toggleCompareMode = () => {
  compareMode.value = !compareMode.value
  if (!compareMode.value) {
    selectedForCompare.value = []
  }
}

const isSelectedForCompare = (templateId: string) => {
  return selectedForCompare.value.includes(templateId)
}

const toggleCompareSelection = (templateId: string) => {
  const index = selectedForCompare.value.indexOf(templateId)
  if (index > -1) {
    selectedForCompare.value.splice(index, 1)
  } else {
    if (selectedForCompare.value.length < 4) {
      selectedForCompare.value.push(templateId)
    } else {
      alert('âš ï¸ æœ€å¤šåªèƒ½é¸æ“‡ 4 å€‹ç¯„æœ¬é€²è¡Œæ¯”è¼ƒ')
    }
  }
}

const closeComparisonModal = () => {
  showComparisonModal.value = false
}

// Phase 2: è©•åˆ†ç³»çµ±
const showRatingModal = (template: StrategyTemplate) => {
  ratingTemplate.value = template
  userRating.value = 0
  hoverRating.value = 0
  showRatingModalFlag.value = true
}

const closeRatingModal = () => {
  showRatingModalFlag.value = false
  ratingTemplate.value = null
  userRating.value = 0
  hoverRating.value = 0
}

const setRating = (rating: number) => {
  userRating.value = rating
}

const getRatingLabel = (rating: number) => {
  const labels = ['', 'å¾ˆå·®', 'ä¸å¥½', 'æ™®é€š', 'è‰¯å¥½', 'å„ªç§€']
  return labels[rating] || ''
}

const submitRating = () => {
  if (userRating.value > 0 && ratingTemplate.value) {
    // æ¨¡æ“¬æäº¤è©•åˆ†ï¼ˆå¯¦éš›æ‡‰è©²ç™¼é€åˆ°å¾Œç«¯ï¼‰
    const template = templates.find(t => t.id === ratingTemplate.value!.id)
    if (template) {
      // æ›´æ–°å¹³å‡è©•åˆ†ï¼ˆç°¡å–®æ¨¡æ“¬ï¼‰
      const totalRating = template.rating.average * template.rating.count + userRating.value
      template.rating.count += 1
      template.rating.average = totalRating / template.rating.count
    }

    alert(`âœ… æ„Ÿè¬æ‚¨çš„è©•åˆ†ï¼æ‚¨çµ¦äº† ${userRating.value} æ˜Ÿ`)
    closeRatingModal()
  }
}
</script>

<style scoped lang="scss">
// [ç¹¼çºŒ CSS æ¨£å¼...]
</style>
