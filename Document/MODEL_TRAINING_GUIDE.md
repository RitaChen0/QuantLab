# 模型訓練指南

## 股票池選擇建議

### 可用股票池

| 股票池 | 股票數量 | 選股邏輯 | 訓練時間估算* | 適用場景 |
|--------|----------|----------|--------------|----------|
| **台股30** | 30支 | 成交量前30大個股 | 5-10分鐘 | 快速測試、驗證因子有效性 |
| **台股50** ⭐ | 50支 | 成交量前50大個股 | 8-15分鐘 | **推薦**：平衡速度與覆蓋率 |
| **台股100** | 100支 | 成交量前100大個股 | 15-25分鐘 | 擴大樣本、提升泛化能力 |
| **台股150** | 150支 | 成交量前150大個股 | 20-35分鐘 | 大樣本訓練 |
| **台股200** | 200支 | 成交量前200大個股 | 25-45分鐘 | 更大樣本訓練 |

\* 訓練時間基於：100 epochs, 800 batch size, 2年數據（2023-2024）

**選股規則**：
- 📊 **按成交量排序**：自動選擇最近30天平均成交量最大的個股
- 🎯 **只選個股**：排除 ETF（00XX 開頭）、期貨等非個股標的
- ✅ **動態更新**：每次訓練時重新計算，確保選到當前最活躍的股票
- 💡 **涵蓋大型股**：成交量大的股票通常是台積電、鴻海、國泰金等權值股

### 訓練時間影響因素

1. **股票數量**：線性影響，股票越多訓練越慢
2. **時間範圍**：數據年份越多，訓練時間越長
3. **訓練輪數**（epochs）：預設100輪，可調整為50-200輪
4. **批次大小**（batch size）：越大訓練越快，但記憶體消耗越高
5. **因子數量**：因子越多，每輪訓練時間越長

### 推薦配置組合

#### 🚀 快速測試（10分鐘內）
```
股票池：台股30
時間範圍：2024-01-01 ~ 2024-12-31（1年）
訓練輪數：50
批次大小：1024
```

#### ⭐ 標準訓練（15分鐘）
```
股票池：台股50
時間範圍：2023-01-01 ~ 2024-12-31（2年）
訓練輪數：100
批次大小：800
```

#### 🎯 高品質訓練（30分鐘）
```
股票池：台股100
時間範圍：2022-01-01 ~ 2024-12-31（3年）
訓練輪數：150
批次大小：800
```

#### ⚠️ 大規模訓練（1小時+）
```
股票池：台股200
時間範圍：2020-01-01 ~ 2024-12-31（5年）
訓練輪數：200
批次大小：512
```

## 因子選擇建議

### 兩種因子模式

#### 🎯 Alpha158+ 增強因子集（推薦用於大樣本訓練）

勾選「使用 Alpha158+ 增強因子集」後，系統會自動使用 **179 個量化因子**：

- **9 個 KBar 因子**：K線形態特徵（實體、影線、收盤價位置等）
- **20 個 Price 因子**：歷史價格序列（當天及過去1-4天的相對價格）
- **5 個 Volume 因子**：成交量序列（當天及過去1-4天的相對成交量）
- **145 個 Rolling 因子**：增強版滾動技術指標（動量、波動率、相關性、線性回歸、成交量分析等）

**優點**：
- ✅ 全面覆蓋：不會遺漏重要特徵
- ✅ 增強版本：基於 Qlib Alpha158 並加入額外成交量分析因子
- ✅ 省時間：無需手動挑選因子

**缺點**：
- ❌ 訓練慢：179 維特徵計算量大（約為手選因子的 10-15 倍）
- ❌ 易過擬合：特徵多，需要大樣本（建議台股50+）
- ❌ 不可解釋：難以理解哪些因子真正有效

**推薦場景**：
- 台股50 以上股票池
- 2 年以上數據
- 追求最佳性能，不在乎訓練時間

#### 📊 手動選擇因子（推薦用於快速測試）

### 推薦的因子組合

#### 基礎組合（5個因子，適合快速測試）
- 動量_20日（動量）
- 均線乖離_MA20（趨勢）
- 波動率_20日（波動）
- 成交量變化_20日（成交量）
- 價量背離（背離）

#### 標準組合（8個因子，推薦）⭐
- 動量_20日（動量）
- 動量_60日（長期動量）
- 均線乖離_MA20（趨勢）
- MACD（趨勢）
- 波動率_20日（波動）
- 布林通道位置（波動）
- 成交量變化_20日（成交量）
- 價量背離（背離）

#### 完整組合（12個因子，最佳性能）
- 動量_5日、動量_20日、動量_60日（多時間尺度動量）
- 均線乖離_MA10、均線乖離_MA20、MACD（趨勢）
- 波動率_20日、價格振幅、布林通道位置（波動）
- 成交量變化_20日、成交量加權動量_10日（成交量）
- 價量背離（背離）

### 因子選擇原則

1. **多樣性**：選擇不同類別的因子（動量、趨勢、波動、成交量）
2. **相關性**：避免選擇高度相關的因子（如動量_5日和動量_10日同時選）
3. **數量**：建議 5-12 個因子，太少可能欠擬合，太多可能過擬合
4. **穩定性**：優先選擇經過驗證的標準技術指標

## 訓練參數說明

### 數據集配置

| 參數 | 預設值 | 建議範圍 | 說明 |
|------|--------|----------|------|
| **訓練集比例** | 70% | 60-80% | 用於模型學習 |
| **驗證集比例** | 15% | 10-20% | 用於早停和超參數調整 |
| **測試集比例** | 15% | 10-20% | 用於最終評估 |

💡 **注意**：三者總和必須為 100%

### 訓練參數配置

| 參數 | 預設值 | 建議範圍 | 說明 |
|------|--------|----------|------|
| **訓練輪數** | 100 | 50-200 | 太少可能欠擬合，太多可能過擬合 |
| **批次大小** | 800 | 256-2048 | 越大訓練越快，但需要更多記憶體 |
| **學習率** | 0.001 | 0.0001-0.01 | 推薦 0.001，太大可能不收斂 |
| **早停輪數** | 20 | 10-50 | 驗證損失N輪未改善時停止訓練 |
| **優化器** | Adam | - | Adam 最穩定（推薦） |
| **損失函數** | MSE | - | 均方誤差（推薦） |

### 批次大小選擇指南

```
256:  記憶體較小時使用，訓練較慢但更穩定
512:  平衡選擇
800:  預設值，推薦使用（推薦）
1024: 快速訓練，適合大數據集
2048: 最快訓練，需要足夠記憶體
```

## 訓練監控

### 關鍵指標

1. **訓練損失（Train Loss）**
   - 應該持續下降
   - 如果不降或上升，可能學習率過大

2. **驗證損失（Valid Loss）**
   - 應該跟隨訓練損失下降
   - 如果開始上升，表示過擬合（早停會自動處理）

3. **測試 IC（Information Coefficient）**
   - 衡量預測與實際的相關性
   - **0.03 以上**：可用模型
   - **0.05 以上**：良好模型
   - **0.08 以上**：優秀模型
   - **0.10 以上**：極佳模型（罕見）

### 常見問題處理

#### 問題：訓練損失是 NaN
**原因**：學習率過大或數據異常
**解決**：
- 降低學習率（0.001 → 0.0001）
- 減少訓練輪數
- 檢查因子公式是否正確

#### 問題：驗證損失持續上升
**原因**：過擬合
**解決**：
- 早停會自動處理
- 減少訓練輪數
- 減少因子數量
- 增加股票數量

#### 問題：測試 IC 接近 0
**原因**：模型沒有學到有效模式
**解決**：
- 選擇更多樣化的因子
- 增加訓練數據（更多股票或更長時間）
- 調整訓練參數（增加輪數、調整學習率）

## 進階技巧

### 1. 數據預處理（自動執行）

系統會自動執行以下預處理步驟，無需手動設定：

#### 📊 標準化方法：RobustScaler

- **使用中位數和 IQR**（四分位距）進行標準化
- **優勢**：對金融數據中的極端值（如漲停、跌停）非常穩健
- **對比 Z-score**：不會被極端值影響，更適合股票數據

```
標準化公式：
X_scaled = (X - median) / IQR
其中 IQR = Q3 - Q1（第75和第25百分位數之差）
```

#### 🛡️ 異常值處理

1. **百分位裁剪**：將極端值裁剪到 P1-P99 範圍
2. **移除 Inf/NaN**：自動清理無效數據
3. **前向填補**：使用 forward fill 填補缺失值（無未來信息洩漏）

#### ✅ 為何這樣設計？

| 問題 | 傳統方法 | 我們的方法 | 優勢 |
|------|---------|-----------|------|
| **極端值** | Z-score 易受影響 | RobustScaler | ✅ 穩健 |
| **未來信息** | backward fill 洩漏 | forward fill only | ✅ 安全 |
| **離群值** | 直接刪除或保留 | P1-P99 裁剪 | ✅ 平衡 |

### 2. 時間範圍選擇

- **牛市數據**：模型可能過度樂觀
- **熊市數據**：模型可能過度保守
- **建議**：包含完整市場週期（至少2年，最好3-5年）

### 3. 因子工程

- 嘗試不同時間窗口的組合（5日、20日、60日）
- 結合多個類別的因子
- 避免高度相關的因子

### 4. 超參數優化

如果首次訓練效果不佳，可以嘗試：
1. **學習率**：0.001 → 0.0005 或 0.002
2. **批次大小**：800 → 512 或 1024
3. **訓練輪數**：100 → 150 或 50

### 4. 模型評估

訓練完成後，關注以下指標：
- **測試 IC**：主要評估指標
- **MSE**：預測誤差大小
- **預測值分布**：應該與實際收益率分布相似

## 故障排除

### 訓練卡住不動
- 檢查 Celery Worker 是否運行
- 查看訓練日誌找出具體錯誤
- 重啟 backend 和 celery-worker

### 訓練失敗
- 檢查錯誤訊息
- 常見錯誤：
  - `window must be an integer`：因子公式有誤
  - `NaN loss`：學習率過大或數據異常
  - `Empty dataframe`：數據不存在

### 記憶體不足
- 減少批次大小（800 → 512 → 256）
- 減少股票數量
- 減少因子數量

---

**更新日期**：2025-12-30
**文檔版本**：1.0
