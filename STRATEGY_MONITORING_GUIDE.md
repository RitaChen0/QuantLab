# ç­–ç•¥å¯¦ç›¤ç›£æ§åŠŸèƒ½ä½¿ç”¨æŒ‡å—

> **åŠŸèƒ½èªªæ˜**: è‡ªå‹•ç›£æ§ ACTIVE ç‹€æ…‹çš„ç­–ç•¥ï¼Œæª¢æ¸¬è²·è³£ä¿¡è™Ÿä¸¦é€šé Telegram é€šçŸ¥ç”¨æˆ¶

**æœ€å¾Œæ›´æ–°**: 2025-12-16

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½

1. **è‡ªå‹•ä¿¡è™Ÿæª¢æ¸¬**: å®šæ™‚åŸ·è¡Œ ACTIVE ç‹€æ…‹çš„ç­–ç•¥ï¼Œæª¢æ¸¬è²·å…¥/è³£å‡ºä¿¡è™Ÿ
2. **Telegram é€šçŸ¥**: æª¢æ¸¬åˆ°ä¿¡è™Ÿå¾Œç«‹å³ç™¼é€ Telegram é€šçŸ¥**ï¼ˆåªé€šçŸ¥ç­–ç•¥æ“æœ‰è€…ï¼‰**
3. **é‡è¤‡ä¿¡è™Ÿéæ¿¾**: 15 åˆ†é˜å…§ç›¸åŒè‚¡ç¥¨ç›¸åŒæ–¹å‘çš„ä¿¡è™Ÿåªé€šçŸ¥ä¸€æ¬¡
4. **å…¨æ™‚æ®µç›£æ§**: è¦†è“‹è‚¡ç¥¨äº¤æ˜“æ™‚æ®µ + å°æŒ‡æœŸå¤œç›¤æ™‚æ®µ

### âš ï¸ éš±ç§ä¿è­·

**é‡è¦**: æ¯å€‹ç­–ç•¥çš„ä¿¡è™Ÿ**åªæœƒé€šçŸ¥çµ¦è©²ç­–ç•¥çš„æ“æœ‰è€…**ï¼Œä¸æœƒé€šçŸ¥å…¶ä»–ç”¨æˆ¶ã€‚

- ç”¨æˆ¶ A çš„ç­–ç•¥ç”¢ç”Ÿçš„ä¿¡è™Ÿ â†’ åªç™¼é€çµ¦ç”¨æˆ¶ A
- ç”¨æˆ¶ B çš„ç­–ç•¥ç”¢ç”Ÿçš„ä¿¡è™Ÿ â†’ åªç™¼é€çµ¦ç”¨æˆ¶ B
- ç¢ºä¿æ¯å€‹ç”¨æˆ¶åªæ”¶åˆ°è‡ªå·±ç­–ç•¥çš„é€šçŸ¥

### ç›£æ§æ™‚é–“è¡¨

| æ™‚æ®µ | æ™‚é–“ç¯„åœ | æª¢æ¸¬é »ç‡ | èªªæ˜ |
|------|---------|---------|------|
| **è‚¡ç¥¨äº¤æ˜“æ™‚æ®µ** | 09:00-13:00 | æ¯ 15 åˆ†é˜ | è‚¡ç¥¨å¸‚å ´é–‹ç›¤æ™‚é–“ |
| **å°æŒ‡æœŸå¤œç›¤ (1)** | 15:00-23:59 | æ¯ 15 åˆ†é˜ | æœŸè²¨å¤œç›¤å‰åŠæ®µ |
| **å°æŒ‡æœŸå¤œç›¤ (2)** | 00:00-05:00 | æ¯ 15 åˆ†é˜ | æœŸè²¨å¤œç›¤å¾ŒåŠæ®µ |

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. å•Ÿç”¨ç­–ç•¥ç›£æ§

åœ¨å‰ç«¯ç­–ç•¥ç®¡ç†é é¢ï¼Œå°‡ç­–ç•¥ç‹€æ…‹è¨­ç½®ç‚º **ACTIVE**ï¼š

```
ç­–ç•¥åˆ—è¡¨ â†’ é¸æ“‡ç­–ç•¥ â†’ ç‹€æ…‹æ”¹ç‚º "å·²å•Ÿç”¨"
```

### 2. ç¢ºä¿ç­–ç•¥é…ç½®æ­£ç¢º

ç­–ç•¥å¿…é ˆåŒ…å«ä»¥ä¸‹é…ç½®ï¼š

```json
{
  "stocks": ["2330", "2317", "2454"]  // å¿…é ˆé…ç½®è‚¡ç¥¨æ¸…å–®
}
```

### 3. ç¶å®š Telegram

ç¢ºä¿å·²ç¶å®š Telegram å¸³è™Ÿï¼š

```
å€‹äººè¨­ç½® â†’ Telegram é€šçŸ¥ â†’ ç¶å®šå¸³è™Ÿ
```

### 4. ç­‰å¾…ä¿¡è™Ÿé€šçŸ¥

ç³»çµ±æœƒè‡ªå‹•åœ¨æ¯å€‹ 15 åˆ†é˜æª¢æŸ¥é»åŸ·è¡Œç­–ç•¥ä¸¦ç™¼é€é€šçŸ¥ã€‚

---

## ğŸ“Š ä¿¡è™Ÿé€šçŸ¥æ ¼å¼

ç•¶æª¢æ¸¬åˆ°è²·è³£ä¿¡è™Ÿæ™‚ï¼Œæ‚¨æœƒæ”¶åˆ°ä»¥ä¸‹æ ¼å¼çš„ Telegram é€šçŸ¥ï¼š

```
ğŸ”” äº¤æ˜“ä¿¡è™Ÿæé†’

ç­–ç•¥ï¼šå‡ç·šäº¤å‰ç­–ç•¥
è‚¡ç¥¨ï¼š2330
ä¿¡è™Ÿï¼šğŸŸ¢ è²·å…¥
åƒ¹æ ¼ï¼šNT$ 580.00
æ™‚é–“ï¼š2025-12-16 10:30:00

é€™æ˜¯ç³»çµ±è‡ªå‹•æª¢æ¸¬çš„ä¿¡è™Ÿï¼Œè«‹è¬¹æ…åˆ¤æ–·å¾Œå†æ±ºå®šæ˜¯å¦äº¤æ˜“ã€‚
```

---

## âš™ï¸ ç³»çµ±æ¶æ§‹

### æ ¸å¿ƒçµ„ä»¶

1. **StrategySignalDetector** (`backend/app/services/strategy_signal_detector.py`)
   - è¼•é‡ç´šç­–ç•¥åŸ·è¡Œå¼•æ“
   - åªæª¢æ¸¬ä¿¡è™Ÿï¼Œä¸é€²è¡Œå®Œæ•´å›æ¸¬
   - æ”¯æ´ Backtrader å¼•æ“ï¼ˆQlib å¼•æ“æš«ä¸æ”¯æ´ï¼‰

2. **Celery å®šæ™‚ä»»å‹™** (`backend/app/tasks/strategy_monitoring.py`)
   - `monitor_active_strategies`: ä¸»ç›£æ§ä»»å‹™
   - `cleanup_old_signals`: æ¸…ç†èˆŠä¿¡è™Ÿè¨˜éŒ„ï¼ˆæ¯é€±åŸ·è¡Œï¼‰

3. **è³‡æ–™è¡¨** (`strategy_signals`)
   - è¨˜éŒ„æ‰€æœ‰æª¢æ¸¬åˆ°çš„ä¿¡è™Ÿ
   - ç”¨æ–¼é‡è¤‡ä¿¡è™Ÿéæ¿¾
   - ä¿ç•™ 30 å¤©æ­·å²è¨˜éŒ„

### ä¿¡è™Ÿæª¢æ¸¬æµç¨‹

```
1. Celery Beat è§¸ç™¼å®šæ™‚ä»»å‹™ï¼ˆæ¯ 15 åˆ†é˜ï¼‰
   â†“
2. æŸ¥è©¢æ‰€æœ‰ ACTIVE ç‹€æ…‹çš„ç­–ç•¥
   â†“
3. å°æ¯å€‹ç­–ç•¥ï¼š
   a. ç²å–æœ€è¿‘ 60 å¤©çš„æ­·å²æ•¸æ“š
   b. åŸ·è¡Œç­–ç•¥é‚è¼¯ï¼ˆåªé‹è¡Œæœ€å¾Œä¸€å€‹ barï¼‰
   c. æª¢æŸ¥æ˜¯å¦æœ‰è²·å…¥/è³£å‡ºä¿¡è™Ÿ
   â†“
4. éæ¿¾é‡è¤‡ä¿¡è™Ÿï¼ˆ15 åˆ†é˜å…§ç›¸åŒè‚¡ç¥¨ç›¸åŒæ–¹å‘ï¼‰
   â†“
5. ä¿å­˜ä¿¡è™Ÿåˆ°è³‡æ–™åº«
   â†“
6. ç™¼é€ Telegram é€šçŸ¥
```

---

## ğŸ”§ æ‰‹å‹•åŸ·è¡Œå‘½ä»¤

### ç«‹å³æª¢æ¸¬ä¿¡è™Ÿï¼ˆæ‰‹å‹•æ¸¬è©¦ï¼‰

```bash
# æª¢æ¸¬æ‰€æœ‰ ACTIVE ç­–ç•¥çš„ä¿¡è™Ÿ
docker compose exec backend celery -A app.core.celery_app call app.tasks.monitor_active_strategies

# æª¢æ¸¬ä¸¦æŒ‡å®šæ•¸æ“šå›æº¯å¤©æ•¸
docker compose exec backend celery -A app.core.celery_app call \
  app.tasks.monitor_active_strategies --kwargs '{"lookback_days": 90}'
```

### æ¸¬è©¦ä¿¡è™Ÿæª¢æ¸¬å™¨ï¼ˆä¸ç™¼é€é€šçŸ¥ï¼‰

```bash
docker compose exec backend python -c "
from app.db.session import SessionLocal
from app.services.strategy_signal_detector import StrategySignalDetector

db = SessionLocal()
detector = StrategySignalDetector(db)

# æª¢æ¸¬æ‰€æœ‰ ACTIVE ç­–ç•¥
signals = detector.detect_signals_for_active_strategies(lookback_days=60)
print(f'æª¢æ¸¬åˆ° {len(signals)} å€‹ä¿¡è™Ÿ')

# é¡¯ç¤ºä¿¡è™Ÿè©³æƒ…
for signal in signals:
    print(f'{signal[\"stock_id\"]} {signal[\"signal_type\"]} @ {signal.get(\"price\", \"N/A\")}')

db.close()
"
```

### æŸ¥è©¢è³‡æ–™åº«ä¸­çš„ä¿¡è™Ÿè¨˜éŒ„

```bash
# æŸ¥è©¢æœ€è¿‘ 10 ç­†ä¿¡è™Ÿï¼ˆåŒ…å«ç”¨æˆ¶è³‡è¨Šï¼‰
docker compose exec postgres psql -U quantlab quantlab -c "
SELECT
  u.username AS user_name,
  s.name AS strategy_name,
  sg.stock_id,
  sg.signal_type,
  sg.price,
  sg.detected_at,
  sg.notified
FROM strategy_signals sg
JOIN strategies s ON sg.strategy_id = s.id
JOIN users u ON sg.user_id = u.id
ORDER BY sg.detected_at DESC
LIMIT 10;
"

# é©—è­‰ä¿¡è™Ÿåªé€šçŸ¥çµ¦ç­–ç•¥æ“æœ‰è€…
docker compose exec postgres psql -U quantlab quantlab -c "
SELECT
  u.username,
  COUNT(*) AS signal_count
FROM strategy_signals sg
JOIN users u ON sg.user_id = u.id
WHERE sg.detected_at > NOW() - INTERVAL '1 day'
GROUP BY u.username;
"

# çµ±è¨ˆä»Šæ—¥ä¿¡è™Ÿæ•¸é‡
docker compose exec postgres psql -U quantlab quantlab -c "
SELECT
  signal_type,
  COUNT(*) AS count
FROM strategy_signals
WHERE detected_at::date = CURRENT_DATE
GROUP BY signal_type;
"
```

### æ¸…ç†èˆŠä¿¡è™Ÿè¨˜éŒ„

```bash
# æ‰‹å‹•æ¸…ç† 30 å¤©å‰çš„ä¿¡è™Ÿ
docker compose exec backend celery -A app.core.celery_app call \
  app.tasks.cleanup_old_signals --kwargs '{"days_to_keep": 30}'
```

---

## ğŸ“‹ å®šæ™‚ä»»å‹™æ¸…å–®

| ä»»å‹™åç¨± | åŸ·è¡Œæ™‚é–“ | Celery Task | èªªæ˜ |
|---------|---------|-------------|------|
| `monitor-strategies-trading-hours` | 09:00-13:00 æ¯ 15 åˆ† | `app.tasks.monitor_active_strategies` | è‚¡ç¥¨äº¤æ˜“æ™‚æ®µç›£æ§ |
| `monitor-strategies-futures-session-1` | 15:00-23:59 æ¯ 15 åˆ† | `app.tasks.monitor_active_strategies` | æœŸè²¨å¤œç›¤å‰åŠæ®µ |
| `monitor-strategies-futures-session-2` | 00:00-05:00 æ¯ 15 åˆ† | `app.tasks.monitor_active_strategies` | æœŸè²¨å¤œç›¤å¾ŒåŠæ®µ |
| `cleanup-old-signals-weekly` | é€±æ—¥ 04:00 | `app.tasks.cleanup_old_signals` | æ¸…ç†èˆŠä¿¡è™Ÿè¨˜éŒ„ |

---

## âš ï¸ é™åˆ¶èˆ‡æ³¨æ„äº‹é …

### ç›®å‰é™åˆ¶

1. **åªæ”¯æ´ Backtrader å¼•æ“**
   - Qlib å¼•æ“çš„ç­–ç•¥æš«ä¸æ”¯æ´å¯¦ç›¤ç›£æ§
   - è¨ˆåŠƒæœªä¾†ç‰ˆæœ¬æ”¯æ´

2. **ç­–ç•¥å¿…é ˆé…ç½®è‚¡ç¥¨æ¸…å–®**
   - `parameters` ä¸­å¿…é ˆåŒ…å« `stocks` é™£åˆ—
   - ç¯„ä¾‹ï¼š`{"stocks": ["2330", "2454"]}`

3. **è¼•é‡ç´šæª¢æ¸¬**
   - åªæª¢æ¸¬æœ€æ–°çš„è²·è³£ä¿¡è™Ÿ
   - ä¸åŸ·è¡Œå®Œæ•´å›æ¸¬é‚è¼¯
   - æ•¸æ“šå›æº¯é è¨­ 60 å¤©

### æ€§èƒ½è€ƒé‡

- **åŸ·è¡Œæ™‚é–“**: æ¯å€‹ç­–ç•¥ç´„ 1-3 ç§’ï¼ˆå–æ±ºæ–¼è‚¡ç¥¨æ•¸é‡ï¼‰
- **å»ºè­°ç­–ç•¥æ•¸é‡**: å»ºè­°åŒæ™‚ ACTIVE çš„ç­–ç•¥ä¸è¶…é 20 å€‹
- **æ•¸æ“šè¼‰å…¥**: æ¯æ¬¡æª¢æ¸¬æœƒè¼‰å…¥æœ€è¿‘ 60 å¤©çš„æ—¥ç·šæ•¸æ“š

### æœ€ä½³å¯¦è¸

1. **ç­–ç•¥ç‹€æ…‹ç®¡ç†**
   - åªå°‡ç¢ºå¯¦è¦ç›£æ§çš„ç­–ç•¥è¨­ç‚º ACTIVE
   - æ¸¬è©¦ä¸­çš„ç­–ç•¥ä½¿ç”¨ DRAFT ç‹€æ…‹
   - ä¸å†ä½¿ç”¨çš„ç­–ç•¥è¨­ç‚º ARCHIVED

2. **ä¿¡è™Ÿç¢ºèª**
   - ç³»çµ±æª¢æ¸¬çš„ä¿¡è™Ÿåƒ…ä¾›åƒè€ƒ
   - å»ºè­°äººå·¥ç¢ºèªå¾Œå†é€²è¡Œäº¤æ˜“
   - è€ƒæ…®è¨­ç½®é¢¨æ§è¦å‰‡

3. **Telegram é€šçŸ¥**
   - ç¢ºä¿ Telegram Bot å·²å•Ÿå‹•
   - å®šæœŸæª¢æŸ¥ç¶å®šç‹€æ…‹
   - è¨­ç½®é€šçŸ¥åå¥½

---

## ğŸ› æ•…éšœæ’æŸ¥

### 1. æ²’æœ‰æ”¶åˆ°é€šçŸ¥

**å¯èƒ½åŸå› **ï¼š
- Telegram æœªç¶å®š â†’ æª¢æŸ¥å€‹äººè¨­ç½®
- ç­–ç•¥ç‹€æ…‹ä¸æ˜¯ ACTIVE â†’ æª¢æŸ¥ç­–ç•¥åˆ—è¡¨
- ç­–ç•¥æ²’æœ‰é…ç½®è‚¡ç¥¨æ¸…å–® â†’ æª¢æŸ¥ parameters
- ä¿¡è™Ÿè¢«é‡è¤‡éæ¿¾ â†’ æª¢æŸ¥æ˜¯å¦ 15 åˆ†é˜å…§æœ‰ç›¸åŒä¿¡è™Ÿ

**æª¢æŸ¥æ­¥é©Ÿ**ï¼š
```bash
# 1. æª¢æŸ¥ Celery Beat æ˜¯å¦é‹è¡Œ
docker compose ps celery-beat

# 2. æŸ¥çœ‹ Celery Beat æ—¥èªŒ
docker compose logs -f celery-beat

# 3. æŸ¥çœ‹ Worker æ—¥èªŒ
docker compose logs -f celery-worker | grep STRATEGY_MONITOR

# 4. æª¢æŸ¥ Telegram Bot ç‹€æ…‹
docker compose ps telegram-bot
```

### 2. ç­–ç•¥åŸ·è¡Œå¤±æ•—

**æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ**ï¼š
```bash
docker compose logs celery-worker | grep -A 10 "STRATEGY_MONITOR.*å¤±æ•—"
```

**å¸¸è¦‹éŒ¯èª¤**ï¼š
- `æ²’æœ‰é…ç½®è‚¡ç¥¨æ¸…å–®` â†’ åœ¨ç­–ç•¥ parameters ä¸­æ·»åŠ  stocks
- `ä½¿ç”¨ qlib å¼•æ“` â†’ ç›®å‰åªæ”¯æ´ Backtrader å¼•æ“
- `æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç­–ç•¥é¡` â†’ æª¢æŸ¥ç­–ç•¥ä»£ç¢¼æ˜¯å¦æ­£ç¢º

### 3. ä¿¡è™Ÿé‡è¤‡

å¦‚æœåŒä¸€å€‹ä¿¡è™Ÿè¢«é‡è¤‡æª¢æ¸¬åˆ°ï¼Œæª¢æŸ¥ï¼š

```bash
# æŸ¥è©¢æœ€è¿‘çš„é‡è¤‡ä¿¡è™Ÿ
docker compose exec postgres psql -U quantlab quantlab -c "
SELECT
  strategy_id,
  stock_id,
  signal_type,
  COUNT(*) AS count,
  MAX(detected_at) - MIN(detected_at) AS time_diff
FROM strategy_signals
WHERE detected_at > NOW() - INTERVAL '1 hour'
GROUP BY strategy_id, stock_id, signal_type
HAVING COUNT(*) > 1;
"
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [CLAUDE.md](CLAUDE.md) - å®Œæ•´é–‹ç™¼æŒ‡å—
- [DATA_SYNC_SCHEDULE.md](DATA_SYNC_SCHEDULE.md) - æ•¸æ“šåŒæ­¥æ’ç¨‹
- [backend/app/services/strategy_signal_detector.py](backend/app/services/strategy_signal_detector.py) - ä¿¡è™Ÿæª¢æ¸¬å™¨åŸå§‹ç¢¼
- [backend/app/tasks/strategy_monitoring.py](backend/app/tasks/strategy_monitoring.py) - ç›£æ§ä»»å‹™åŸå§‹ç¢¼

---

## ğŸ”„ ç‰ˆæœ¬æ­·å²

- **v1.0** (2025-12-16)
  - åˆå§‹ç‰ˆæœ¬
  - æ”¯æ´ Backtrader å¼•æ“
  - è¦†è“‹è‚¡ç¥¨ + æœŸè²¨äº¤æ˜“æ™‚æ®µ
  - Telegram é€šçŸ¥æ•´åˆ
  - é‡è¤‡ä¿¡è™Ÿéæ¿¾ï¼ˆ15 åˆ†é˜ï¼‰

---

**æ–‡æª”ç‰ˆæœ¬**: 1.0
**ç¶­è­·è€…**: é–‹ç™¼åœ˜éšŠ
**æœ€å¾Œæ›´æ–°**: 2025-12-16
