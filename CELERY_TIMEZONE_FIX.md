# Celery æ™‚å€å•é¡Œè¨ºæ–·èˆ‡ä¿®å¾©å ±å‘Š

## ğŸ“‹ å•é¡Œæè¿°

**ç”¨æˆ¶åæ˜ ï¼š** å®šæ™‚ä»»å‹™æ²’æœ‰åŸ·è¡Œï¼Œéƒ½éœ€è¦æ‰‹å‹•è§¸ç™¼

**ç—‡ç‹€ï¼š**
- å®šæ™‚ä»»å‹™é…ç½®åœ¨ 21:00ã€08:00 ç­‰æ™‚é–“åŸ·è¡Œ
- å¯¦éš›ä¸Šé€™äº›æ™‚é–“é»æ²’æœ‰ä»»å‹™åŸ·è¡Œ
- åªæœ‰ cleanup-cache-daily åœ¨ 11:00 åŸ·è¡Œï¼ˆçœ‹ä¼¼æ­£å¸¸ï¼‰

---

## ğŸ” å•é¡Œè¨ºæ–·

### 1. æ™‚å€é…ç½®è¡çª

**åŸå§‹é…ç½®** (`/backend/app/core/celery_app.py`):
```python
celery_app.conf.update(
    timezone="Asia/Taipei",  # è¨­å®šç‚ºå°åŒ—æ™‚å€
    enable_utc=True,         # âŒ ä½†å•Ÿç”¨äº† UTC æ¨¡å¼
    ...
)
```

### 2. å•é¡Œåˆ†æ

ç•¶ `enable_utc=True` æ™‚ï¼ŒCelery Beat æœƒå°‡æ‰€æœ‰ crontab æ™‚é–“è¦–ç‚º **UTC æ™‚é–“**ï¼Œè€Œä¸æ˜¯ `timezone` è¨­å®šçš„æ™‚å€ã€‚

**å¯¦éš›åŸ·è¡Œæ™‚é–“å°ç…§è¡¨ï¼š**

| ä»»å‹™ | crontab è¨­å®š | é æœŸåŸ·è¡Œï¼ˆå°åŒ—æ™‚é–“ï¼‰ | å¯¦éš›åŸ·è¡Œï¼ˆUTCâ†’å°åŒ—ï¼‰ | åå·® |
|------|-------------|-------------------|-------------------|-----|
| sync-stock-list-daily | `crontab(hour=8, minute=0)` | 08:00 | **16:00** | +8 å°æ™‚ âŒ |
| sync-daily-prices | `crontab(hour=21, minute=0)` | 21:00 | **æ¬¡æ—¥ 05:00** | +8 å°æ™‚ âŒ |
| sync-ohlcv-daily | `crontab(hour=22, minute=0)` | 22:00 | **æ¬¡æ—¥ 06:00** | +8 å°æ™‚ âŒ |
| cleanup-cache-daily | `crontab(hour=3, minute=0)` | 03:00 | **11:00** | +8 å°æ™‚ âœ…ï¼ˆçœ‹ä¼¼æ­£å¸¸ï¼‰ |
| sync-institutional-investors | `crontab(hour=21, minute=0)` | 21:00 | **æ¬¡æ—¥ 05:00** | +8 å°æ™‚ âŒ |

**ç‚ºä»€éº¼ cleanup-cache-daily çœ‹èµ·ä¾†æ­£å¸¸ï¼Ÿ**
- è¨­å®šç‚º UTC 03:00
- è½‰æ›ç‚ºå°åŒ—æ™‚é–“ = 03:00 + 8 = 11:00
- å‰›å¥½åœ¨ç™½å¤©åŸ·è¡Œï¼Œç”¨æˆ¶çœ‹åˆ°äº†æ—¥èªŒ

**ç‚ºä»€éº¼å…¶ä»–ä»»å‹™æ²’åŸ·è¡Œï¼Ÿ**
- é æœŸåœ¨æ™šä¸Š 21:00ã€22:00 åŸ·è¡Œ
- å¯¦éš›åœ¨æ¬¡æ—¥å‡Œæ™¨ 05:00ã€06:00 åŸ·è¡Œ
- ç”¨æˆ¶ç™½å¤©æŸ¥çœ‹æ™‚ï¼Œçœ‹ä¸åˆ°é€™äº›ä»»å‹™çš„åŸ·è¡Œè¨˜éŒ„

---

## âœ… è§£æ±ºæ–¹æ¡ˆ

### ä¿®å¾©é…ç½®

**ä¿®æ”¹æ–‡ä»¶ï¼š** `/backend/app/core/celery_app.py`

```python
celery_app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="Asia/Taipei",
    enable_utc=False,  # âœ… æ”¹ç‚º Falseï¼Œä½¿ç”¨æœ¬åœ°æ™‚å€
    task_track_started=True,
    ...
)
```

### ä¿®å¾©å¾Œçš„åŸ·è¡Œæ™‚é–“

| ä»»å‹™ | crontab è¨­å®š | åŸ·è¡Œæ™‚é–“ï¼ˆå°åŒ—æ™‚é–“ï¼‰ | ç‹€æ…‹ |
|------|-------------|-------------------|-----|
| sync-stock-list-daily | `crontab(hour=8, minute=0)` | **08:00** | âœ… |
| sync-daily-prices | `crontab(hour=21, minute=0)` | **21:00** | âœ… |
| sync-ohlcv-daily | `crontab(hour=22, minute=0)` | **22:00** | âœ… |
| cleanup-cache-daily | `crontab(hour=3, minute=0)` | **03:00** | âœ… |
| sync-institutional-investors | `crontab(hour=21, minute=0)` | **21:00** | âœ… |
| sync-fundamental-latest | `crontab(hour=23, minute=0)` | **23:00** | âœ… |
| sync-latest-prices-frequent | `crontab(*/15, 9-13)` | **9:00-13:00 æ¯ 15 åˆ†é˜** | âœ… |
| cleanup-institutional-data | `crontab(hour=2, minute=0, day_of_week='sunday')` | **é€±æ—¥ 02:00** | âœ… |
| sync-fundamental-weekly | `crontab(hour=4, minute=0, day_of_week='sunday')` | **é€±æ—¥ 04:00** | âœ… |

---

## ğŸ”§ æ‡‰ç”¨ä¿®å¾©

### 1. ä¿®æ”¹é…ç½®
```bash
# å·²ä¿®æ”¹ /backend/app/core/celery_app.py
# enable_utc=True â†’ enable_utc=False
```

### 2. é‡å•Ÿæœå‹™
```bash
docker compose restart celery-beat celery-worker backend
```

### 3. é©—è­‰é…ç½®
```bash
# æª¢æŸ¥æ™‚å€è¨­å®š
docker compose exec backend python3 -c "
import sys
sys.path.insert(0, '/app')
from app.core.celery_app import celery_app
print(f'Timezone: {celery_app.conf.timezone}')
print(f'Enable UTC: {celery_app.conf.enable_utc}')
"
```

**é æœŸè¼¸å‡ºï¼š**
```
Timezone: Asia/Taipei
Enable UTC: False  â† ç¢ºèªç‚º False
```

---

## ğŸ“Š ä½¿ç”¨å¾Œå°ç®¡ç†æŸ¥çœ‹ä»»å‹™ç‹€æ…‹

### è¨ªå•å¾Œå°ç®¡ç†
```
URL: http://localhost:3000/admin
ç™»å…¥ï¼šä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿ
```

### æ•¸æ“šåŒæ­¥ç®¡ç†åŠŸèƒ½

**ä½ç½®ï¼š** å¾Œå°ç®¡ç† â†’ æ•¸æ“šåŒæ­¥ Tab

**åŠŸèƒ½ï¼š**
1. **æŸ¥çœ‹æ‰€æœ‰å®šæ™‚ä»»å‹™**
   - ä»»å‹™åç¨±
   - æ’ç¨‹æ™‚é–“
   - æœ€å¾ŒåŸ·è¡Œæ™‚é–“
   - åŸ·è¡Œç‹€æ…‹ï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
   - åŸ·è¡Œçµæœ

2. **æ‰‹å‹•è§¸ç™¼ä»»å‹™**
   - é»æ“Šã€Œç«‹å³åŸ·è¡Œã€æŒ‰éˆ•
   - ç„¡éœ€ç­‰å¾…å®šæ™‚åŸ·è¡Œ
   - é©åˆæ¸¬è©¦æˆ–ç·Šæ€¥åŒæ­¥

3. **æŸ¥çœ‹åŸ·è¡Œä¸­çš„ä»»å‹™**
   - å¯¦æ™‚é¡¯ç¤ºæ­£åœ¨åŸ·è¡Œçš„ä»»å‹™
   - ä»»å‹™ ID
   - ä»»å‹™ç‹€æ…‹

4. **æŸ¥çœ‹ Celery Workers**
   - Worker ä¸»æ©Ÿå
   - é‹è¡Œç‹€æ…‹
   - åŸ·è¡Œä¸­çš„ä»»å‹™æ•¸
   - ç´¯è¨ˆè™•ç†ä»»å‹™æ•¸
   - é‹è¡Œæ™‚é–“

### æˆªåœ–ç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•¸æ“šåŒæ­¥ç®¡ç†                         ğŸ”„ åˆ·æ–°        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ åŒæ­¥æ³•äººè²·è³£è¶…ï¼ˆTop 100ï¼‰             active  â”‚    â”‚
â”‚ â”‚ ä»»å‹™åç¨±: app.tasks.sync_top_stocks...      â”‚    â”‚
â”‚ â”‚ æ’ç¨‹: æ¯å¤© 21:00                             â”‚    â”‚
â”‚ â”‚ æœ€å¾ŒåŸ·è¡Œ: 2025-12-12 21:00:05  âœ… æˆåŠŸ      â”‚    â”‚
â”‚ â”‚ åŸ·è¡Œçµæœ: åŒæ­¥ 20 æª”è‚¡ç¥¨ï¼Œ16,875 ç­†è¨˜éŒ„     â”‚    â”‚
â”‚ â”‚                          [ç«‹å³åŸ·è¡Œ] æŒ‰éˆ•      â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                     â”‚
â”‚ åŸ·è¡Œä¸­çš„ä»»å‹™                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ ç›®å‰æ²’æœ‰åŸ·è¡Œä¸­çš„ä»»å‹™                         â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                     â”‚
â”‚ Celery Workers                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ celery@worker1                              â”‚    â”‚
â”‚ â”‚ ç‹€æ…‹: online | âš¡ åŸ·è¡Œä¸­: 0 | âœ… ç´¯è¨ˆ: 142  â”‚    â”‚
â”‚ â”‚ â±ï¸ é‹è¡Œæ™‚é–“: 2 å¤© 3 å°æ™‚                    â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª é©—è­‰ä¿®å¾©

### 1. æª¢æŸ¥ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“

```bash
# æŸ¥çœ‹ Celery Beat æ—¥èªŒ
docker compose logs celery-beat --tail 50 | grep "Waking up"
```

**é æœŸçœ‹åˆ°ï¼š**
```
beat: Waking up in X.XX minutes
```

### 2. ç­‰å¾…ä¸‹å€‹æ•´é»

**æ¸¬è©¦ä»»å‹™ï¼š** `sync-latest-prices-frequent`
- **æ’ç¨‹ï¼š** äº¤æ˜“æ™‚æ®µæ¯ 15 åˆ†é˜ï¼ˆ9:00-13:00ï¼‰
- **æ¸¬è©¦æ–¹æ³•ï¼š** åœ¨é€±ä¸€è‡³é€±äº”çš„ 9:00-13:00 æœŸé–“ï¼Œæ¯ 15 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ—¥èªŒ

```bash
# å¯¦æ™‚ç›£æ§ä»»å‹™åŸ·è¡Œ
docker compose logs celery-worker -f | grep "sync_latest_prices"
```

### 3. æ‰‹å‹•è§¸ç™¼æ¸¬è©¦

åœ¨å¾Œå°ç®¡ç†é é¢æ‰‹å‹•è§¸ç™¼ä»»å‹™ï¼Œé©—è­‰åŠŸèƒ½æ­£å¸¸ï¼š

1. è¨ªå• http://localhost:3000/admin
2. åˆ‡æ›åˆ°ã€Œæ•¸æ“šåŒæ­¥ã€Tab
3. æ‰¾åˆ°ä»»æ„ä»»å‹™ï¼Œé»æ“Šã€Œç«‹å³åŸ·è¡Œã€
4. è§€å¯Ÿä»»å‹™åŸ·è¡Œç‹€æ…‹

---

## ğŸ“ å®šæ™‚ä»»å‹™ç¸½è¦½

### æ¯æ—¥ä»»å‹™

| æ™‚é–“ | ä»»å‹™ | èªªæ˜ |
|------|------|------|
| 03:00 | cleanup-cache-daily | æ¸…ç†éæœŸå¿«å– |
| 08:00 | sync-stock-list-daily | åŒæ­¥è‚¡ç¥¨åˆ—è¡¨ |
| 21:00 | sync-daily-prices | åŒæ­¥æ¯æ—¥åƒ¹æ ¼ |
| 21:00 | sync-institutional-investors | åŒæ­¥æ³•äººè²·è³£è¶…ï¼ˆTop 100ï¼Œè¿‘ 7 å¤©ï¼‰ |
| 22:00 | sync-ohlcv-daily | åŒæ­¥ OHLCV æ•¸æ“š |
| 23:00 | sync-fundamental-latest | å¿«é€ŸåŒæ­¥è²¡å‹™æ•¸æ“š |

### äº¤æ˜“æ™‚æ®µä»»å‹™

| æ™‚é–“ | ä»»å‹™ | èªªæ˜ |
|------|------|------|
| 09:00-13:00<br/>æ¯ 15 åˆ†é˜ | sync-latest-prices-frequent | åŒæ­¥æœ€æ–°åƒ¹æ ¼<br/>ï¼ˆåƒ…é€±ä¸€è‡³é€±äº”ï¼‰ |

### é€±åº¦ä»»å‹™

| æ™‚é–“ | ä»»å‹™ | èªªæ˜ |
|------|------|------|
| é€±æ—¥ 02:00 | cleanup-institutional-data | æ¸…ç† 365 å¤©å‰çš„æ³•äººæ•¸æ“š |
| é€±æ—¥ 04:00 | sync-fundamental-weekly | å®Œæ•´åŒæ­¥è²¡å‹™æ•¸æ“š |

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### å•é¡Œï¼šä»»å‹™é‚„æ˜¯æ²’åŸ·è¡Œ

**1. æª¢æŸ¥ Celery Beat æ˜¯å¦é‹è¡Œ**
```bash
docker compose ps celery-beat
```

**é æœŸï¼š** State ç‚º `running`

**2. æª¢æŸ¥æ™‚å€é…ç½®**
```bash
docker compose exec backend python3 -c "
import sys
sys.path.insert(0, '/app')
from app.core.celery_app import celery_app
print('Timezone:', celery_app.conf.timezone)
print('Enable UTC:', celery_app.conf.enable_utc)
"
```

**é æœŸè¼¸å‡ºï¼š**
```
Timezone: Asia/Taipei
Enable UTC: False
```

**3. æŸ¥çœ‹ Beat æ’ç¨‹**
```bash
docker compose logs celery-beat --tail 30 | grep "ScheduleEntry"
```

**æ‡‰è©²çœ‹åˆ°æ‰€æœ‰ä»»å‹™åˆ—è¡¨**

**4. æª¢æŸ¥ç³»çµ±æ™‚é–“**
```bash
date
docker compose exec backend date
docker compose exec celery-beat date
```

**ç¢ºä¿æ™‚é–“ä¸€è‡´**

### å•é¡Œï¼šæ‰‹å‹•è§¸ç™¼å¤±æ•—

**1. æª¢æŸ¥ Worker ç‹€æ…‹**
```bash
docker compose ps celery-worker
```

**2. æª¢æŸ¥ Worker æ—¥èªŒ**
```bash
docker compose logs celery-worker --tail 50
```

**3. æª¢æŸ¥ä»»å‹™æ˜¯å¦è¨»å†Š**
```bash
docker compose logs celery-worker | grep "registered"
```

**æ‡‰è©²çœ‹åˆ°æ‰€æœ‰ä»»å‹™å·²è¨»å†Š**

---

## ğŸ“– ç›¸é—œæ–‡æª”

- **å¾Œå°ç®¡ç†ä½¿ç”¨æŒ‡å—ï¼š** è¨ªå• http://localhost:3000/admin
- **Celery ä»»å‹™é…ç½®ï¼š** `/backend/app/core/celery_app.py`
- **ä»»å‹™å¯¦ä½œï¼š** `/backend/app/tasks/`
- **API ç«¯é»ï¼š** `/backend/app/api/v1/admin.py`

---

## âœ… ç¸½çµ

**å•é¡Œæ ¹æºï¼š** `enable_utc=True` å°è‡´æ‰€æœ‰ crontab æ™‚é–“ä½¿ç”¨ UTC æ™‚å€ï¼Œèˆ‡é æœŸçš„å°åŒ—æ™‚é–“ç›¸å·® 8 å°æ™‚

**è§£æ±ºæ–¹æ¡ˆï¼š** å°‡ `enable_utc` æ”¹ç‚º `False`ï¼Œè®“ Celery ä½¿ç”¨ `timezone="Asia/Taipei"` è¨­å®š

**é©—è­‰æ–¹å¼ï¼š**
1. å¾Œå°ç®¡ç†é é¢æŸ¥çœ‹ä»»å‹™ç‹€æ…‹
2. ç­‰å¾…ä¸‹å€‹åŸ·è¡Œæ™‚é–“é»ï¼Œè§€å¯Ÿæ—¥èªŒ
3. æ‰‹å‹•è§¸ç™¼ä»»å‹™æ¸¬è©¦

**ä¿®å¾©å¾Œï¼š** æ‰€æœ‰å®šæ™‚ä»»å‹™å°‡æŒ‰ç…§å°åŒ—æ™‚é–“æº–æ™‚åŸ·è¡Œ âœ…

---

**ä¿®å¾©æ—¥æœŸï¼š** 2024-12-13
**æ–‡æª”ç‰ˆæœ¬ï¼š** 1.0
**è²¬ä»»äººï¼š** Claude Code Assistant
