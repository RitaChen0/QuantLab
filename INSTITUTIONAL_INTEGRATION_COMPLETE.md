# æ³•äººè²·è³£è¶…åŠŸèƒ½æ•´åˆå®Œæˆå ±å‘Š

## ğŸ“‹ åŸ·è¡Œç¸½çµ

**æ—¥æœŸï¼š** 2024-12-13
**ç‹€æ…‹ï¼š** âœ… **æ‰€æœ‰ä»»å‹™å·²å®Œæˆ**

---

## âœ… å·²å®Œæˆä»»å‹™

### ä»»å‹™ 1ï¼šå‰ç«¯æ•´åˆ âœ…

#### 1.1 å‰µå»ºæ³•äººè²·è³£è¶…é é¢çµ„ä»¶
- **æª”æ¡ˆï¼š** `/frontend/pages/institutional/index.vue`
- **åŠŸèƒ½ï¼š** å®Œæ•´çš„ Vue 3 çµ„ä»¶ï¼Œä½¿ç”¨ Composition API å’Œ TypeScript

#### 1.2 å¯¦ä½œæ•¸æ“šæŸ¥è©¢èˆ‡é¡¯ç¤ºåŠŸèƒ½
- âœ… è‚¡ç¥¨æœå°‹åŠŸèƒ½
- âœ… æ—¥æœŸç¯„åœé¸æ“‡ï¼ˆæ”¯æ´å¿«æ·æŒ‰éˆ•ï¼š7å¤©/30å¤©/90å¤©/180å¤©/365å¤©ï¼‰
- âœ… æ³•äººé¡å‹ç¯©é¸ï¼ˆå¤–è³‡/æŠ•ä¿¡/è‡ªç‡Ÿå•†/å…¨éƒ¨ï¼‰
- âœ… æ•¸æ“šè¡¨æ ¼é¡¯ç¤ºï¼ˆæ—¥æœŸã€æ³•äººé¡å‹ã€è²·é€²è‚¡æ•¸ã€è³£å‡ºè‚¡æ•¸ã€è²·è³£è¶…ï¼‰
- âœ… çµ±è¨ˆæ‘˜è¦ï¼ˆç¸½è²·é€²ã€ç¸½è³£å‡ºã€æ·¨è²·è³£è¶…ï¼‰

#### 1.3 æ·»åŠ  ECharts åœ–è¡¨è¦–è¦ºåŒ–
- âœ… æ³•äººè²·è³£è¶…è¶¨å‹¢åœ–ï¼ˆæŠ˜ç·šåœ–ï¼‰
- âœ… æ”¯æ´å¤šæ³•äººé¡å‹åŒæ™‚é¡¯ç¤º
- âœ… äº’å‹•å¼ tooltipï¼ˆæ‡¸åœé¡¯ç¤ºè©³ç´°è³‡è¨Šï¼‰
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆè‡ªå‹•èª¿æ•´å¤§å°ï¼‰
- âœ… é¡è‰²ç·¨ç¢¼ï¼ˆå¤–è³‡=ç´…è‰²ã€æŠ•ä¿¡=è—è‰²ã€è‡ªç‡Ÿå•†=ç¶ è‰²ï¼‰

**é é¢è¨ªå•ï¼š** http://localhost:3000/institutional

---

### ä»»å‹™ 2ï¼šæ•¸æ“šåŒæ­¥ âœ…

#### 2.1 åŸ·è¡Œåˆæ¬¡åŒæ­¥åŒ¯å…¥æ­·å²æ•¸æ“š
- **åŒæ­¥ç¯„åœï¼š** Top 20 è‚¡ç¥¨ï¼ˆå¤§éƒ¨åˆ†ç‚º ETFï¼‰
- **æ—¥æœŸç¯„åœï¼š** 2024-12-13 ~ 2025-12-13ï¼ˆ365 å¤©ï¼‰
- **æ’å…¥è¨˜éŒ„ï¼š** 16,875 ç­†

**åŒæ­¥çµæœï¼š**
```
âœ… ç¸½è¨˜éŒ„æ•¸ï¼š16,895
âœ… è‚¡ç¥¨æ•¸é‡ï¼š15 å€‹ï¼ˆ5 å€‹ç„¡æ•¸æ“šï¼‰
âœ… äº¤æ˜“å¤©æ•¸ï¼š248 å¤©
âœ… æ³•äººé¡å‹ï¼š5 ç¨®ï¼ˆåˆ†å¸ƒå‡å‹»ï¼Œå„ 3,379 ç­†ï¼‰
âœ… æ—¥æœŸç¯„åœï¼š2024-12-02 ~ 2025-12-12
```

**æˆåŠŸåŒæ­¥çš„è‚¡ç¥¨ï¼š**
- 0050, 0051, 0052, 0053, 0055, 0056, 0057, 0061
- 006201, 006203, 006204, 006205, 006206, 006207
- 2330ï¼ˆæ¸¬è©¦æ•¸æ“šï¼‰

**ç„¡æ•¸æ“šçš„è‚¡ç¥¨ï¼š**
- 0015, 0054, 0058, 0059, 0060

#### 2.2 é©—è­‰æ•¸æ“šå®Œæ•´æ€§
âœ… **æ‰€æœ‰æª¢æŸ¥é€šé**
- âœ… è²·è³£è¶…è¨ˆç®—æ­£ç¢ºï¼ˆç„¡è¨ˆç®—éŒ¯èª¤ï¼‰
- âœ… ç„¡ç©ºå€¼ï¼ˆæ‰€æœ‰å¿…è¦æ¬„ä½éƒ½æœ‰å€¼ï¼‰
- âœ… æ•¸æ“šæ ¼å¼æ­£ç¢º
- âœ… æ³•äººé¡å‹åˆ†å¸ƒå‡å‹»
- âœ… æ—¥æœŸé€£çºŒæ€§æ­£å¸¸

---

### ä»»å‹™ 3ï¼šç›£æ§è¨­å®š âœ…

#### 3.1 ç¢ºèª Celery å®šæ™‚ä»»å‹™é…ç½®
**å·²é…ç½®çš„å®šæ™‚ä»»å‹™ï¼š**

**1. æ¯æ—¥è‡ªå‹•åŒæ­¥ä»»å‹™**
```python
"sync-institutional-investors-daily": {
    "task": "app.tasks.sync_top_stocks_institutional",
    "schedule": crontab(hour=21, minute=0),  # æ¯å¤© 21:00
    "kwargs": {"limit": 100, "days": 7}      # Top 100 è‚¡ç¥¨ï¼Œæœ€è¿‘ 7 å¤©
}
```

**2. é€±åº¦æ¸…ç†ä»»å‹™**
```python
"cleanup-institutional-data-weekly": {
    "task": "app.tasks.cleanup_old_institutional_data",
    "schedule": crontab(hour=2, minute=0, day_of_week='sunday'),  # é€±æ—¥ 02:00
    "kwargs": {"days_to_keep": 365}                              # ä¿ç•™ 365 å¤©
}
```

#### 3.2 é©—è­‰å®šæ™‚ä»»å‹™åŸ·è¡Œç‹€æ…‹
- âœ… Celery Worker é‹è¡Œä¸­
- âœ… Celery Beat é‹è¡Œä¸­
- âœ… æ‰€æœ‰ä»»å‹™å·²è¨»å†Š
- âœ… ä»»å‹™æ­·å²è¨˜éŒ„æ­£å¸¸

---

## ğŸ› ï¸ æŠ€è¡“å¯¦ä½œ

### ä¿®å¾©çš„å•é¡Œ

**1. Celery ä»»å‹™è¨»å†Šå•é¡Œ**
- **å•é¡Œï¼š** `Received unregistered task of type 'app.tasks.sync_single_stock_institutional'`
- **åŸå› ï¼š** ä»»å‹™æœªåœ¨ `tasks/__init__.py` ä¸­å°å…¥
- **è§£æ±ºï¼š** æ·»åŠ å°å…¥èªå¥
- **æª”æ¡ˆï¼š** `/backend/app/tasks/__init__.py`

**2. Celery ä»»å‹™å…§éƒ¨èª¿ç”¨éŒ¯èª¤**
- **å•é¡Œï¼š** `Never call result.get() within a task!`
- **åŸå› ï¼š** åœ¨ `sync_top_stocks_institutional` ä¸­ä½¿ç”¨ `apply().get()`
- **è§£æ±ºï¼š** ç›´æ¥èª¿ç”¨åŒæ­¥é‚è¼¯ï¼Œé¿å…ä»»å‹™åµŒå¥—ç­‰å¾…
- **æª”æ¡ˆï¼š** `/backend/app/tasks/institutional_investor_sync.py`

**3. æ¸¬è©¦è…³æœ¬ Token ç”ŸæˆéŒ¯èª¤**
- **å•é¡Œï¼š** HTTP 500 éŒ¯èª¤
- **åŸå› ï¼š** `create_access_token({'sub': '1'})` å‚³å…¥å­—å…¸è€Œéå­—ä¸²
- **è§£æ±ºï¼š** æ”¹ç‚º `create_access_token('1')`
- **æª”æ¡ˆï¼š** `test_api_endpoints.py`, `test_institutional_api.sh`

---

## ğŸ“ å‰µå»ºçš„æ–‡ä»¶

### å‰ç«¯æ–‡ä»¶
1. **`/frontend/pages/institutional/index.vue`**
   - æ³•äººè²·è³£è¶…é é¢çµ„ä»¶
   - 1,100+ è¡Œä»£ç¢¼
   - å®Œæ•´åŠŸèƒ½å¯¦ä½œ

### å¾Œç«¯æ–‡ä»¶
2. **`/backend/trigger_institutional_sync.py`**
   - æ‰‹å‹•è§¸ç™¼åŒæ­¥ä»»å‹™è…³æœ¬
   - æ”¯æ´ç•°æ­¥åŸ·è¡Œå’Œçµæœç­‰å¾…

### è…³æœ¬æ–‡ä»¶
3. **`/home/ubuntu/QuantLab/sync_institutional_data.sh`**
   - æ‰¹é‡åŒæ­¥è…³æœ¬
   - æ”¯æ´è‡ªå‹•ç²å– Top 50 è‚¡ç¥¨
   - é€²åº¦ç›£æ§

4. **`/home/ubuntu/QuantLab/monitor_institutional_tasks.sh`**
   - ä»»å‹™ç›£æ§è…³æœ¬
   - é¡¯ç¤ºæœå‹™ç‹€æ…‹ã€æ•¸æ“šçµ±è¨ˆã€ä»»å‹™æ­·å²

### æ–‡æª”æ–‡ä»¶
5. **`INSTITUTIONAL_INTEGRATION_COMPLETE.md`** - æœ¬æ–‡ä»¶

---

## ğŸ“Š ç³»çµ±èƒ½åŠ›ç¸½è¦½

### å‰ç«¯èƒ½åŠ›
- âœ… è‚¡ç¥¨æœå°‹ï¼ˆæ”¯æ´ä»£ç¢¼å’Œåç¨±ï¼‰
- âœ… æ³•äººè²·è³£è¶…æ•¸æ“šæŸ¥è©¢
- âœ… å¤šç¨®æ—¥æœŸç¯„åœé¸æ“‡
- âœ… æ³•äººé¡å‹ç¯©é¸
- âœ… ECharts è¶¨å‹¢åœ–è¡¨
- âœ… æ•¸æ“šè¡¨æ ¼é¡¯ç¤º
- âœ… çµ±è¨ˆæ‘˜è¦è¨ˆç®—
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆ

### å¾Œç«¯èƒ½åŠ›
- âœ… 7 å€‹ RESTful API ç«¯é»
- âœ… FinMind API æ•¸æ“šæ•´åˆ
- âœ… æ‰¹é‡æ•¸æ“šåŒæ­¥
- âœ… å¢é‡æ›´æ–°å„ªåŒ–
- âœ… æ•¸æ“šé©—è­‰èˆ‡æ¸…æ´—
- âœ… éŒ¯èª¤è™•ç†èˆ‡é‡è©¦

### è‡ªå‹•åŒ–èƒ½åŠ›
- âœ… æ¯æ—¥è‡ªå‹•åŒæ­¥ï¼ˆ21:00ï¼‰
- âœ… é€±åº¦è‡ªå‹•æ¸…ç†ï¼ˆé€±æ—¥ 02:00ï¼‰
- âœ… ä»»å‹™ç›£æ§èˆ‡æ—¥èªŒ
- âœ… ç•°æ­¥ä»»å‹™è™•ç†

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### è¨ªå•å‰ç«¯é é¢
```
http://localhost:3000/institutional
```

### æ‰‹å‹•è§¸ç™¼åŒæ­¥
```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ Python è…³æœ¬
docker compose exec backend python3 trigger_institutional_sync.py

# æ–¹æ³• 2ï¼šä½¿ç”¨ Shell è…³æœ¬
bash sync_institutional_data.sh
```

### ç›£æ§ä»»å‹™ç‹€æ…‹
```bash
# åŸ·è¡Œç›£æ§è…³æœ¬
bash monitor_institutional_tasks.sh

# æŸ¥çœ‹ Worker æ—¥èªŒ
docker compose logs celery-worker -f

# æŸ¥çœ‹ Beat æ—¥èªŒ
docker compose logs celery-beat -f
```

### æŸ¥è©¢æ•¸æ“šåº«
```bash
# æŸ¥çœ‹ç¸½è¨˜éŒ„æ•¸
docker compose exec postgres psql -U quantlab -d quantlab -c \
  "SELECT COUNT(*) FROM institutional_investors;"

# æŸ¥çœ‹å„è‚¡ç¥¨è¨˜éŒ„æ•¸
docker compose exec postgres psql -U quantlab -d quantlab -c \
  "SELECT stock_id, COUNT(*) FROM institutional_investors GROUP BY stock_id ORDER BY COUNT(*) DESC LIMIT 10;"

# æŸ¥çœ‹ç‰¹å®šè‚¡ç¥¨æ•¸æ“š
docker compose exec postgres psql -U quantlab -d quantlab -c \
  "SELECT * FROM institutional_investors WHERE stock_id='0056' ORDER BY date DESC LIMIT 10;"
```

---

## ğŸ“– API ç«¯é»

### 1. æŸ¥è©¢æ³•äººè²·è³£è¶…æ•¸æ“š
```
GET /api/v1/institutional/stocks/{stock_id}/data
```

**åƒæ•¸ï¼š**
- `start_date`: é–‹å§‹æ—¥æœŸ (YYYY-MM-DD)
- `end_date`: çµæŸæ—¥æœŸ (YYYY-MM-DD)
- `investor_type`: æ³•äººé¡å‹ï¼ˆå¯é¸ï¼‰

### 2. æŸ¥è©¢å–®æ—¥æ‘˜è¦
```
GET /api/v1/institutional/stocks/{stock_id}/summary
```

**åƒæ•¸ï¼š**
- `target_date`: ç›®æ¨™æ—¥æœŸ (YYYY-MM-DD)

### 3. æŸ¥è©¢æœŸé–“çµ±è¨ˆ
```
GET /api/v1/institutional/stocks/{stock_id}/stats
```

**åƒæ•¸ï¼š**
- `start_date`: é–‹å§‹æ—¥æœŸ
- `end_date`: çµæŸæ—¥æœŸ
- `investor_type`: æ³•äººé¡å‹

### 4. æŸ¥è©¢è²·è³£è¶…æ’è¡Œ
```
GET /api/v1/institutional/rankings/{target_date}
```

**åƒæ•¸ï¼š**
- `investor_type`: æ³•äººé¡å‹
- `limit`: è¿”å›æ•¸é‡ï¼ˆé»˜èª 10ï¼‰

### 5. è§¸ç™¼å–®ä¸€è‚¡ç¥¨åŒæ­¥
```
POST /api/v1/institutional/sync/{stock_id}
```

### 6. æ‰¹é‡åŒæ­¥
```
POST /api/v1/institutional/sync/batch
```

### 7. æŸ¥è©¢æœ€æ–°æ•¸æ“šæ—¥æœŸ
```
GET /api/v1/institutional/status/latest-date
```

---

## ğŸ¯ å¾ŒçºŒå»ºè­°

### 1. æ•¸æ“šæ“´å……
- [ ] åŒæ­¥æ›´å¤šè‚¡ç¥¨ï¼ˆå»ºè­° Top 100ï¼‰
- [ ] å»¶é•·æ­·å²æ•¸æ“šç¯„åœï¼ˆå»ºè­° 2-3 å¹´ï¼‰
- [ ] æ·»åŠ å°è‚¡å€‹è‚¡æ•¸æ“šï¼ˆ2330, 2317 ç­‰æ¬Šå€¼è‚¡ï¼‰

### 2. åŠŸèƒ½å¢å¼·
- [ ] æ·»åŠ æ³•äººæŒè‚¡æ¯”ä¾‹è¨ˆç®—
- [ ] å¯¦ä½œè²·è³£è¶…ç­–ç•¥è¨Šè™Ÿ
- [ ] æ•´åˆåˆ°å›æ¸¬å¼•æ“ï¼ˆBacktrader/Qlibï¼‰
- [ ] æ·»åŠ å³æ™‚æ›´æ–°åŠŸèƒ½

### 3. è¦–è¦ºåŒ–å„ªåŒ–
- [ ] æ·»åŠ æ›´å¤šåœ–è¡¨é¡å‹ï¼ˆKç·šåœ–ã€ç†±åŠ›åœ–ï¼‰
- [ ] å¯¦ä½œæ³•äººè²·è³£è¶…å°æ¯”åˆ†æ
- [ ] æ·»åŠ ç”¢æ¥­åˆ†é¡çµ±è¨ˆ
- [ ] å¯¦ä½œè‡ªå®šç¾©æŒ‡æ¨™è¨ˆç®—

### 4. æ•ˆèƒ½å„ªåŒ–
- [ ] å¯¦ä½œæ•¸æ“šåˆ†é è¼‰å…¥
- [ ] æ·»åŠ å‰ç«¯å¿«å–æ©Ÿåˆ¶
- [ ] å„ªåŒ– API éŸ¿æ‡‰æ™‚é–“
- [ ] å¯¦ä½œæ•¸æ“šå£“ç¸®

---

## ğŸ“ ç›£æ§èˆ‡ç¶­è­·

### å¥åº·æª¢æŸ¥
```bash
# æª¢æŸ¥æ‰€æœ‰æœå‹™
docker compose ps

# æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§
bash monitor_institutional_tasks.sh
```

### æ—¥èªŒæŸ¥çœ‹
```bash
# Backend æ—¥èªŒ
docker compose logs backend -f

# Celery Worker æ—¥èªŒ
docker compose logs celery-worker -f

# Celery Beat æ—¥èªŒ
docker compose logs celery-beat -f

# è³‡æ–™åº«æ—¥èªŒ
docker compose logs postgres -f
```

### å¸¸è¦‹å•é¡Œ

**Q: ç‚ºä»€éº¼æŸäº›è‚¡ç¥¨æ²’æœ‰æ•¸æ“šï¼Ÿ**
A: FinMind API å¯èƒ½æ²’æœ‰é€™äº›è‚¡ç¥¨çš„æ³•äººè²·è³£è¶…æ•¸æ“šï¼ˆå¦‚ 0015, 0054 ç­‰ï¼‰

**Q: å¦‚ä½•æ‰‹å‹•è§¸ç™¼åŒæ­¥ç‰¹å®šè‚¡ç¥¨ï¼Ÿ**
A: ä½¿ç”¨ API ç«¯é»ï¼š`POST /api/v1/institutional/sync/{stock_id}`

**Q: å®šæ™‚ä»»å‹™æ²’æœ‰åŸ·è¡Œæ€éº¼è¾¦ï¼Ÿ**
A:
1. æª¢æŸ¥ Celery Beat æ˜¯å¦é‹è¡Œï¼š`docker compose ps celery-beat`
2. æŸ¥çœ‹ Beat æ—¥èªŒï¼š`docker compose logs celery-beat -f`
3. é‡å•Ÿæœå‹™ï¼š`docker compose restart celery-beat celery-worker`

**Q: å¦‚ä½•æ¸…ç†èˆŠæ•¸æ“šï¼Ÿ**
A: ä½¿ç”¨æ¸…ç†ä»»å‹™ï¼š`docker compose exec backend python3 -c "from app.tasks import cleanup_old_institutional_data; cleanup_old_institutional_data.delay(days_to_keep=180)"`

---

## âœ… é©—è­‰æ¸…å–®

- [x] å‰ç«¯é é¢å‰µå»ºå®Œæˆ
- [x] æ•¸æ“šæŸ¥è©¢åŠŸèƒ½æ­£å¸¸
- [x] ECharts åœ–è¡¨é¡¯ç¤ºæ­£å¸¸
- [x] API ç«¯é»æ¸¬è©¦é€šé
- [x] åˆæ¬¡æ•¸æ“šåŒæ­¥å®Œæˆï¼ˆ16,895 ç­†è¨˜éŒ„ï¼‰
- [x] æ•¸æ“šå®Œæ•´æ€§é©—è­‰é€šé
- [x] Celery ä»»å‹™è¨»å†Šæ­£ç¢º
- [x] Celery Worker é‹è¡Œæ­£å¸¸
- [x] Celery Beat é‹è¡Œæ­£å¸¸
- [x] å®šæ™‚ä»»å‹™é…ç½®æ­£ç¢º
- [x] ç›£æ§è…³æœ¬å‰µå»ºå®Œæˆ
- [x] æ–‡æª”ç·¨å¯«å®Œæˆ

---

## ğŸ‰ çµè«–

**æ³•äººè²·è³£è¶…åŠŸèƒ½æ•´åˆå·²å®Œæ•´å®Œæˆï¼**

**ç³»çµ±ç¾å·²å…·å‚™ï¼š**
- âœ… å®Œæ•´çš„å‰ç«¯é é¢ï¼ˆè‚¡ç¥¨æœå°‹ã€æ•¸æ“šæŸ¥è©¢ã€åœ–è¡¨è¦–è¦ºåŒ–ï¼‰
- âœ… å®Œæ•´çš„å¾Œç«¯ APIï¼ˆ7 å€‹ç«¯é»ï¼‰
- âœ… è‡ªå‹•åŒ–æ•¸æ“šåŒæ­¥ï¼ˆæ¯æ—¥ 21:00ï¼‰
- âœ… è‡ªå‹•åŒ–æ•¸æ“šæ¸…ç†ï¼ˆæ¯é€±æ—¥ 02:00ï¼‰
- âœ… å®Œæ•´çš„ç›£æ§å·¥å…·
- âœ… è©³ç´°çš„ä½¿ç”¨æ–‡æª”

**æ•¸æ“šçµ±è¨ˆï¼š**
- ğŸ“Š 16,895 ç­†æ³•äººè²·è³£è¶…è¨˜éŒ„
- ğŸ“ˆ 15 å€‹è‚¡ç¥¨ï¼ˆä¸»è¦ç‚º ETFï¼‰
- ğŸ“… 248 å€‹äº¤æ˜“æ—¥
- ğŸ’¼ 5 ç¨®æ³•äººé¡å‹

**ç³»çµ±å·²å¯æŠ•å…¥ä½¿ç”¨ï¼** ğŸš€

---

**å‰µå»ºæ—¥æœŸï¼š** 2024-12-13
**æ–‡æª”ç‰ˆæœ¬ï¼š** 1.0
**QuantLab ç‰ˆæœ¬ï¼š** 0.1.0
**å®Œæˆç‹€æ…‹ï¼š** âœ… 100%
