# 因子評估前端使用指南

## 📍 訪問位置

1. 登入 QuantLab 系統
2. 導航到 **自動研發**（RD-Agent）頁面：`http://localhost:3000/rdagent`
3. 點擊 **「生成的因子」** 標籤頁

## 🎯 使用流程

### 步驟 1：生成因子

如果還沒有因子，需要先生成：

1. 在「因子挖掘」標籤頁填寫研究目標
2. 點擊「🚀 開始挖掘」按鈕
3. 等待 AI 生成因子（約 2-5 分鐘）

### 步驟 2：評估因子

在「生成的因子」標籤頁中，每個因子卡片都有：

1. **📊 評估因子** 按鈕
   - 點擊後開始評估該因子
   - 評估期間按鈕顯示「⏳ 評估中...」
   - 評估約需 10-30 秒（取決於股票數量）

2. **📜 評估歷史** 按鈕（如果有評估記錄）
   - 顯示該因子的所有歷史評估記錄數量
   - 點擊查看詳細歷史（功能開發中）

### 步驟 3：查看評估結果

點擊「評估因子」後，會彈出評估結果模態框，包含：

#### 因子預測能力指標

- **IC (Information Coefficient)**
  - 因子值與未來收益的相關性
  - 參考值：|IC| > 0.05 為有效因子

- **ICIR (IC Information Ratio)**
  - IC 的穩定性指標
  - 參考值：ICIR > 0.5 為穩定因子

- **Rank IC / Rank ICIR**
  - 排名相關性（對異常值更穩健）

#### 回測績效指標

- **Sharpe Ratio**
  - 風險調整後收益
  - 參考值：> 1.0 為良好

- **年化報酬率**
  - 策略的年化收益
  - 顯示為百分比

- **最大回撤**
  - 從峰值到谷底的最大跌幅
  - 越小越好

- **勝率**
  - 收益為正的交易日佔比
  - 顯示為百分比

## 🎨 視覺化指標

評估結果使用顏色編碼：

- 🟢 **綠色**：優秀（IC > 0.05, Sharpe > 1.0）
- 🔵 **藍色**：良好（0 < IC < 0.05）
- 🔴 **紅色**：不佳（IC < 0）

## 📊 評估設定

目前評估使用以下預設設定：

- **股票池**：全市場（all）
- **評估期間**：2024-01-01 ~ 2024-12-31
- **回測策略**：多空對沖
  - 做多因子值最高的 20% 股票
  - 做空因子值最低的 20% 股票

## 🔄 API 調用流程

```
前端按鈕點擊
    ↓
POST /api/v1/factor-evaluation/evaluate
    ↓
後端因子評估服務
    ↓
1. 讀取因子公式
2. 使用 Qlib 計算因子值
3. 計算 IC/ICIR 指標
4. 執行簡單回測
5. 計算 Sharpe/年化報酬等
    ↓
儲存到 factor_evaluations 表
    ↓
返回評估結果給前端
    ↓
顯示評估模態框
```

## 🖼️ 界面截圖說明

### 因子卡片示例

```
┌─────────────────────────────────────┐
│ 20 Day SMA Momentum      ✏️         │
├─────────────────────────────────────┤
│ 基於 20 日簡單移動平均的動量因子      │
│                                     │
│ 公式: Mean($close, 20) / $close - 1 │
│                                     │
│ IC: 0.0523  Sharpe: 1.24           │
├─────────────────────────────────────┤
│ [查看代碼 ▼]                        │
├─────────────────────────────────────┤
│ [📊 評估因子] [📜 評估歷史 (3)]      │
└─────────────────────────────────────┘
```

### 評估結果模態框

```
┌──────────────────────────────────────────┐
│ 📊 因子評估結果                      ✕  │
├──────────────────────────────────────────┤
│ 20 Day SMA Momentum                      │
│ 評估期間：2024-01-01 ~ 2024-12-31        │
│ 股票池：all (2671 檔股票)                │
├──────────────────────────────────────────┤
│ 🎯 因子預測能力    │ 💰 回測績效         │
│                    │                     │
│ IC      0.0523 ✅   │ Sharpe     1.24 ✅  │
│ ICIR    0.612 ✅    │ 年化報酬   15.3% ✅ │
│ Rank IC 0.0489 ✅   │ 最大回撤   -12.5%   │
│ Rank ICIR 0.558 ✅  │ 勝率       54.2%    │
├──────────────────────────────────────────┤
│ 💡 提示：IC > 0.05 表示有效因子，        │
│ Sharpe > 1.0 表示良好績效                │
└──────────────────────────────────────────┘
```

## ⚙️ 技術細節

### 前端實現

- **狀態管理**：
  - `evaluatingFactorId` - 當前評估的因子 ID
  - `showEvaluationModal` - 模態框顯示狀態
  - `evaluationResult` - 評估結果數據

- **主要函數**：
  - `evaluateFactor(factorId)` - 觸發評估
  - `closeEvaluationModal()` - 關閉模態框
  - `formatMetric(value)` - 格式化數值
  - `getMetricClass(value)` - 獲取顏色樣式

### 後端 API

- **端點**：`POST /api/v1/factor-evaluation/evaluate`
- **請求體**：
  ```json
  {
    "factor_id": 1,
    "stock_pool": "all",
    "start_date": "2024-01-01",
    "end_date": "2024-12-31"
  }
  ```
- **響應**：包含所有評估指標的 JSON 對象

## 🚨 常見問題

### Q: 評估按鈕是灰色的，無法點擊？
A: 這表示正在評估另一個因子，請等待當前評估完成。

### Q: 評估失敗，顯示錯誤訊息？
A: 可能原因：
1. 因子公式有誤
2. 缺少必要的數據
3. Qlib 數據未同步
4. 超過速率限制（5 次/小時）

查看後端日誌：`docker compose logs backend | grep factor_evaluation`

### Q: 評估結果中顯示 N/A？
A: 表示該指標無法計算，可能是數據不足或計算失敗。

### Q: 如何修改評估期間或股票池？
A: 目前需要修改前端代碼（`frontend/pages/rdagent/index.vue` 第 520-524 行）。未來會添加自定義設定界面。

## 🔮 後續功能

計劃添加的功能：

1. **自定義評估參數**
   - 可選擇評估期間
   - 可選擇股票池（全市場/前100/自定義）
   - 可調整回測策略參數

2. **評估歷史查看**
   - 查看因子的所有評估記錄
   - 比較不同時期的評估結果
   - 視覺化 IC 時間序列

3. **批量評估**
   - 一次評估多個因子
   - 比較不同因子的表現
   - 導出評估報告

4. **視覺化增強**
   - IC 時間序列圖表
   - 累積報酬曲線
   - 回撤圖表

## 📚 相關文件

- **後端實現**：`FACTOR_EVALUATION_GUIDE.md`
- **API 文檔**：http://localhost:8000/docs#/因子評估
- **代碼位置**：
  - 前端：`frontend/pages/rdagent/index.vue`
  - 後端服務：`backend/app/services/factor_evaluation_service.py`
  - API 端點：`backend/app/api/v1/factor_evaluation.py`
