# è³‡æ–™åº«å®Œæ•´æ€§ä¿éšœç³»çµ±

> **æ ¸å¿ƒç†å¿µ**ï¼šè³‡æ–™åº«å®Œæ•´æ€§æ˜¯ç³»çµ±çš„åŸºçŸ³ï¼Œæ•¸æ“šå“è³ªæ±ºå®šäº¤æ˜“ç­–ç•¥çš„å¯é æ€§

## ğŸ“‹ ç³»çµ±æ¦‚è¦½

### ä¸‰å±¤é˜²è­·æ©Ÿåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 1 å±¤ï¼šè‡ªå‹•æª¢æŸ¥ï¼ˆæ¯æ—¥ 06:00ï¼‰                         â”‚
â”‚  - æª¢æŸ¥æ—¥ç·šæ•¸æ“šå®Œæ•´æ€§ï¼ˆ30 å¤©ï¼‰                           â”‚
â”‚  - æª¢æŸ¥åˆ†é˜ç·šæ•¸æ“šå®Œæ•´æ€§ï¼ˆ7 å¤©ï¼‰                          â”‚
â”‚  - æª¢æŸ¥ Qlib æ•¸æ“šä¸€è‡´æ€§                                  â”‚
â”‚  - è¨˜éŒ„æ‰€æœ‰å•é¡Œä¸¦ç”Ÿæˆå ±å‘Š                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 2 å±¤ï¼šè‡ªå‹•ä¿®å¾©ï¼ˆæ¯æ—¥ 06:30ï¼‰                         â”‚
â”‚  - æ—¥ç·šç¼ºå¤± â†’ å¾åˆ†é˜ç·šèšåˆè£œé½Š                          â”‚
â”‚  - åˆ†é˜ç·šç¼ºå¤± â†’ å¾ Shioaji API åŒæ­¥                     â”‚
â”‚  - è‡ªå‹•é‡è©¦å¤±æ•—ä»»å‹™                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 3 å±¤ï¼šæ‰‹å‹•å·¥å…·ï¼ˆæŒ‰éœ€åŸ·è¡Œï¼‰                           â”‚
â”‚  - å¿«é€Ÿæª¢æŸ¥è…³æœ¬                                          â”‚
â”‚  - æ™ºæ…§è£œé½Šå·¥å…·                                          â”‚
â”‚  - è©³ç´°å ±å‘Šç”Ÿæˆ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ æ ¸å¿ƒå·¥å…·

### 1. è³‡æ–™åº«å®Œæ•´æ€§æª¢æŸ¥å™¨

**è…³æœ¬**ï¼š`backend/scripts/check_database_integrity.py`

**åŠŸèƒ½**ï¼š
- âœ… æª¢æŸ¥æ—¥ç·šæ•¸æ“šå®Œæ•´æ€§ï¼ˆstock_pricesï¼‰
- âœ… æª¢æŸ¥åˆ†é˜ç·šæ•¸æ“šå®Œæ•´æ€§ï¼ˆstock_minute_pricesï¼‰
- âœ… æª¢æŸ¥ Qlib æ•¸æ“šä¸€è‡´æ€§
- âœ… è‡ªå‹•ä¿®å¾©ç¼ºå¤±æ•¸æ“š
- âœ… ç”Ÿæˆå®Œæ•´æ€§å ±å‘Š

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# å®Œæ•´æª¢æŸ¥
docker compose exec backend python /app/scripts/check_database_integrity.py --check-all

# æª¢æŸ¥ä¸¦è‡ªå‹•ä¿®å¾©
docker compose exec backend python /app/scripts/check_database_integrity.py --fix-all

# åªæª¢æŸ¥ç‰¹å®šé¡å‹
docker compose exec backend python /app/scripts/check_database_integrity.py --check-daily
docker compose exec backend python /app/scripts/check_database_integrity.py --check-minute
docker compose exec backend python /app/scripts/check_database_integrity.py --check-qlib

# ç”Ÿæˆå ±å‘Š
docker compose exec backend python /app/scripts/check_database_integrity.py --check-all --report --output /tmp/integrity_report.txt
```

**æª¢æŸ¥é …ç›®**ï¼š

| é¡å‹ | æª¢æŸ¥ç¯„åœ | çµ±è¨ˆæŒ‡æ¨™ |
|------|---------|---------|
| æ—¥ç·š | æœ€è¿‘ 30 å¤© | ç¼ºå¤±æ—¥æœŸã€è‚¡ç¥¨æ•¸ã€è¦†è“‹ç‡ |
| åˆ†é˜ç·š | æœ€è¿‘ 7 å¤© | æ¯æ—¥è‚¡ç¥¨æ•¸ã€åˆ†é˜ç·šæ•¸ |
| Qlib | æ—¥ç·š + åˆ†é˜ç·š | ç›®éŒ„å­˜åœ¨æ€§ã€è‚¡ç¥¨æ•¸ |

### 2. æ—¥ç·šç¼ºå¤±è£œé½Šå·¥å…·

**è…³æœ¬**ï¼š`backend/scripts/backfill_daily_from_minute.py`

**æ™ºæ…§æ¨¡å¼**ï¼ˆâœ¨ æ–°å¢ï¼‰ï¼š
```bash
# ğŸ§  è‡ªå‹•æª¢æ¸¬åˆ†é˜ç·šç¯„åœå…§çš„æ‰€æœ‰ç¼ºå¤±ä¸¦è£œé½Š
docker compose exec backend python /app/scripts/backfill_daily_from_minute.py --smart

# æ™ºæ…§æª¢æŸ¥ï¼ˆä¸ä¿®å¾©ï¼‰
docker compose exec backend python /app/scripts/backfill_daily_from_minute.py --smart --check

# æ™ºæ…§é è¦½ï¼ˆä¸å¯«å…¥ï¼‰
docker compose exec backend python /app/scripts/backfill_daily_from_minute.py --smart --dry-run
```

**èšåˆé‚è¼¯**ï¼š
- **Open**ï¼šç•¶å¤©ç¬¬ä¸€ç­†åˆ†é˜ç·šçš„ open
- **High**ï¼šç•¶å¤©æ‰€æœ‰åˆ†é˜ç·šçš„æœ€é«˜åƒ¹
- **Low**ï¼šç•¶å¤©æ‰€æœ‰åˆ†é˜ç·šçš„æœ€ä½åƒ¹
- **Close**ï¼šç•¶å¤©æœ€å¾Œä¸€ç­†åˆ†é˜ç·šçš„ close
- **Volume**ï¼šç•¶å¤©æ‰€æœ‰åˆ†é˜ç·šçš„ volume ç¸½å’Œ

**é™åˆ¶**ï¼š
- åªèƒ½è£œé½Šæœ‰åˆ†é˜ç·šè³‡æ–™çš„è‚¡ç¥¨ï¼ˆ~2,317 æª”ï¼‰
- PostgreSQL åˆ†é˜ç·šä¿ç•™ 6 å€‹æœˆ
- Qlib åˆ†é˜ç·šä¿ç•™ 7 å¹´

### 3. åˆ†é˜ç·šåŒæ­¥å·¥å…·

**è…³æœ¬**ï¼š`backend/scripts/sync_shioaji_to_qlib.py`

**æ™‚å€ä¿®å¾©**ï¼ˆğŸ”§ å·²ä¿®å¾©ï¼‰ï¼š
```python
# âŒ éŒ¯èª¤ï¼ˆèˆŠä»£ç¢¼ï¼‰- å°è‡´æ‰€æœ‰æ•¸æ“šè¢«éæ¿¾
dt = pd.to_datetime(timestamp_ns, unit='ns', utc=True).tz_convert('Asia/Taipei').tz_localize(None)
# çµæœï¼š09:01 â†’ 17:01ï¼ˆå¤šåŠ äº† 8 å°æ™‚ï¼‰

# âœ… æ­£ç¢ºï¼ˆæ–°ä»£ç¢¼ï¼‰
dt = pd.to_datetime(timestamp_ns, unit='ns').tz_localize('Asia/Taipei').tz_localize(None)
# çµæœï¼š09:01 â†’ 09:01
```

**æ™ºæ…§åŒæ­¥**ï¼š
```bash
# è‡ªå‹•æª¢æ¸¬è³‡æ–™åº«æœ€å¾Œæ—¥æœŸï¼ŒåªåŒæ­¥ç¼ºå¤±éƒ¨åˆ†
docker compose exec backend python /app/scripts/sync_shioaji_to_qlib.py --smart
```

## â° è‡ªå‹•åŒ–å®šæ™‚ä»»å‹™

### Celery Beat æ’ç¨‹

| æ™‚é–“ | ä»»å‹™ | ç”¨é€” |
|------|------|------|
| 06:00 | `check-database-integrity-daily` | æª¢æŸ¥æ—¥ç·šã€åˆ†é˜ç·šã€Qlib å®Œæ•´æ€§ |
| 06:30 | `auto-fix-database-daily` | è‡ªå‹•ä¿®å¾©æ‰€æœ‰å¯ä¿®å¾©çš„ç¼ºå¤± |

**ä»»å‹™é…ç½®**ï¼ˆ`backend/app/core/celery_app.py`ï¼‰ï¼š
```python
"check-database-integrity-daily": {
    "task": "app.tasks.check_database_integrity",
    "schedule": crontab(hour=22, minute=0),  # UTC 22:00 = Taiwan 06:00
    "options": {"expires": 82800},  # 23 hours
},

"auto-fix-database-daily": {
    "task": "app.tasks.auto_fix_database",
    "schedule": crontab(hour=22, minute=30),  # UTC 22:30 = Taiwan 06:30
    "options": {"expires": 82800},  # 23 hours
},
```

## ğŸš€ å¿«é€Ÿä½¿ç”¨æŒ‡å—

### æ¯æ—¥ç¶­è­·æµç¨‹

```bash
# 1ï¸âƒ£ å¿«é€Ÿæª¢æŸ¥ï¼ˆæ¨è–¦ï¼‰
bash scripts/db-integrity-check.sh

# 2ï¸âƒ£ å¦‚æœç™¼ç¾ç¼ºå¤±ï¼Œè‡ªå‹•ä¿®å¾©
bash scripts/db-integrity-check.sh --fix
```

### æ·±åº¦æª¢æŸ¥æµç¨‹

```bash
# 1ï¸âƒ£ å®Œæ•´æª¢æŸ¥
docker compose exec backend python /app/scripts/check_database_integrity.py --check-all

# 2ï¸âƒ£ æ™ºæ…§è£œé½Šæ—¥ç·šï¼ˆå¦‚æœæœ‰ç¼ºå¤±ï¼‰
docker compose exec backend python /app/scripts/backfill_daily_from_minute.py --smart

# 3ï¸âƒ£ æ™ºæ…§è£œé½Šåˆ†é˜ç·šï¼ˆå¦‚æœæœ‰ç¼ºå¤±ï¼‰
docker compose exec backend python /app/scripts/sync_shioaji_to_qlib.py --smart

# 4ï¸âƒ£ ç”Ÿæˆå ±å‘Š
docker compose exec backend python /app/scripts/check_database_integrity.py \
  --check-all --report --output /tmp/integrity_report.txt
```

## ğŸ“Š æª¢æŸ¥è¼¸å‡ºç¯„ä¾‹

```
============================================================
ğŸ¥ è³‡æ–™åº«å®Œæ•´æ€§æª¢æŸ¥ç³»çµ±
============================================================

============================================================
ğŸ“Š æª¢æŸ¥æ—¥ç·šæ•¸æ“šå®Œæ•´æ€§ï¼ˆstock_pricesï¼‰
============================================================

ğŸ“… æª¢æŸ¥ç¯„åœ: 2025-11-25 ~ 2025-12-25 (30 å¤©)
ğŸ“Š è‚¡ç¥¨ç¸½æ•¸: 2,675 æª”
ğŸ“ˆ æ•¸æ“šç¯„åœ: 2007-04-23 ~ 2025-12-24
âœ… è¦†è“‹ç‡: 96.7%

âš ï¸  ç™¼ç¾ 1 å€‹ç¼ºå¤±æ—¥æœŸ:
  ğŸ”´ 2025-12-25

============================================================
â±ï¸  æª¢æŸ¥åˆ†é˜ç·šæ•¸æ“šå®Œæ•´æ€§ï¼ˆstock_minute_pricesï¼‰
============================================================

ğŸ“… æ•¸æ“šç¯„åœ: 2025-06-25 ~ 2025-12-24
ğŸ“Š è‚¡ç¥¨æ•¸: 2,317 æª”
ğŸ“ˆ ç¸½åˆ†é˜ç·š: 58,346,409 ç­†

ğŸ“… æœ€è¿‘ 7 å¤©çµ±è¨ˆ:
  âŒ 2025-12-25: ç„¡æ•¸æ“š
  âœ… 2025-12-24: 2,284 æª”, 165,512 ç­†
  âœ… 2025-12-23: 2,244 æª”, 155,569 ç­†
  âœ… 2025-12-22: 2,243 æª”, 157,360 ç­†
  âœ… 2025-12-19: 2,248 æª”, 149,450 ç­†

============================================================
ğŸ“Š æª¢æŸ¥ Qlib æ•¸æ“šä¸€è‡´æ€§
============================================================

âœ… Qlib æ—¥ç·šç›®éŒ„: /data/qlib/tw_stock_v2
   ğŸ“Š è‚¡ç¥¨æ•¸: 2,672 æª”

âœ… Qlib åˆ†é˜ç·šç›®éŒ„: /data/qlib/tw_stock_minute
   ğŸ“Š è‚¡ç¥¨æ•¸: 2,313 æª”

============================================================
âœ… æª¢æŸ¥å®Œæˆ
============================================================
ğŸ“Š çµ±è¨ˆ: æ—¥ç·šç¼ºå¤± 1, åˆ†é˜ç·šç¼ºå¤± 1, å·²ä¿®å¾© 0, éŒ¯èª¤ 0
```

## ğŸ”§ æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šæ—¥ç·šæ•¸æ“šç¼ºå¤±

**ç—‡ç‹€**ï¼š
```
âš ï¸  ç™¼ç¾ 3 å€‹ç¼ºå¤±æ—¥æœŸ:
  ğŸ”´ 2025-12-19
  ğŸ”´ 2025-12-20
  ğŸ”´ 2025-12-23
```

**è§£æ±º**ï¼š
```bash
# è‡ªå‹•è£œé½Šï¼ˆä½¿ç”¨åˆ†é˜ç·šèšåˆï¼‰
docker compose exec backend python /app/scripts/backfill_daily_from_minute.py --smart
```

### å•é¡Œ 2ï¼šåˆ†é˜ç·šæ•¸æ“šç¼ºå¤±

**ç—‡ç‹€**ï¼š
```
ğŸ“… æœ€è¿‘ 7 å¤©çµ±è¨ˆ:
  âŒ 2025-12-24: ç„¡æ•¸æ“š
  âŒ 2025-12-23: ç„¡æ•¸æ“š
```

**è§£æ±º**ï¼š
```bash
# å¾ Shioaji API åŒæ­¥
docker compose exec backend python /app/scripts/sync_shioaji_to_qlib.py --smart
```

### å•é¡Œ 3ï¼šæ™‚å€è½‰æ›éŒ¯èª¤

**ç—‡ç‹€**ï¼šåˆ†é˜ç·šåŒæ­¥è¿”å› 0 ç­†ï¼Œä½† API ç¢ºå¯¦æœ‰æ•¸æ“š

**åŸå› **ï¼šæ™‚é–“è¢«éŒ¯èª¤è½‰æ›ï¼Œè¶…å‡ºäº¤æ˜“æ™‚æ®µè¢«éæ¿¾

**è§£æ±º**ï¼šå·²ä¿®å¾©ï¼ˆ`shioaji_client.py:442`ï¼‰

## ğŸ“ˆ æ•¸æ“šå“è³ªæŒ‡æ¨™

### ç›®æ¨™æ¨™æº–

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | ç•¶å‰å€¼ |
|------|--------|--------|
| æ—¥ç·šè¦†è“‹ç‡ï¼ˆ30 å¤©ï¼‰ | â‰¥ 95% | 96.7% âœ… |
| åˆ†é˜ç·šè¦†è“‹ç‡ï¼ˆ7 å¤©ï¼‰ | â‰¥ 90% | 85.7% âš ï¸ |
| Qlib è‚¡ç¥¨æ•¸ï¼ˆæ—¥ç·šï¼‰ | â‰¥ 2,600 | 2,672 âœ… |
| Qlib è‚¡ç¥¨æ•¸ï¼ˆåˆ†é˜ç·šï¼‰ | â‰¥ 2,200 | 2,313 âœ… |

### ç›£æ§å»ºè­°

- **æ¯æ—¥**ï¼šåŸ·è¡Œå¿«é€Ÿæª¢æŸ¥ï¼ˆ`db-integrity-check.sh`ï¼‰
- **æ¯é€±**ï¼šç”Ÿæˆå®Œæ•´å ±å‘Šä¸¦å­˜æª”
- **æ¯æœˆ**ï¼šæª¢æŸ¥æ­·å²è¶¨å‹¢ï¼Œè©•ä¼°æ•¸æ“šå“è³ª

## ğŸ¯ æœ€ä½³å¯¦è¸

1. **é é˜²æ€§æª¢æŸ¥**ï¼šæ¯å¤©æ—©ä¸Šæª¢æŸ¥ï¼Œé¿å…å•é¡Œç´¯ç©
2. **åŠæ™‚ä¿®å¾©**ï¼šç™¼ç¾ç¼ºå¤±ç«‹å³è£œé½Šï¼Œé¿å…å½±éŸ¿å›æ¸¬
3. **ç›£æ§è¶¨å‹¢**ï¼šé—œæ³¨ç¼ºå¤±æ¨¡å¼ï¼Œç™¼ç¾ç³»çµ±æ€§å•é¡Œ
4. **ä¿ç•™æ—¥èªŒ**ï¼šä¿å­˜æª¢æŸ¥å ±å‘Šï¼Œè¿½è¹¤å•é¡Œæ­·å²
5. **å®šæœŸå¯©æŸ¥**ï¼šæ¯æœˆæª¢è¦–è‡ªå‹•ä¿®å¾©æ•ˆæœï¼Œèª¿æ•´ç­–ç•¥

## ğŸ“ ç›¸é—œæ–‡ä»¶

- **ä¸»æ–‡æª”**ï¼š`CLAUDE.md`
- **æ™‚å€ç­–ç•¥**ï¼š`TIMEZONE_COMPLETE_GUIDE.md`
- **Celery é…ç½®**ï¼š`backend/app/core/celery_app.py`
- **å®Œæ•´æ€§æª¢æŸ¥å™¨**ï¼š`backend/scripts/check_database_integrity.py`
- **æ—¥ç·šè£œé½Šå·¥å…·**ï¼š`backend/scripts/backfill_daily_from_minute.py`
- **åˆ†é˜ç·šåŒæ­¥**ï¼š`backend/scripts/sync_shioaji_to_qlib.py`

---

**ç‰ˆæœ¬**ï¼š1.0.0
**æ›´æ–°æ—¥æœŸ**ï¼š2025-12-25
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ
