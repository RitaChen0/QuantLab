# 後台管理面板使用指南

> 後台管理功能說明與常見問題解答

**最後更新**: 2025-12-16

---

## 📋 目錄

1. [功能概覽](#功能概覽)
2. [數據同步 vs 策略監控](#數據同步-vs-策略監控)
3. [各分頁功能說明](#各分頁功能說明)
4. [常見問題](#常見問題)

---

## 🎯 功能概覽

後台管理面板（`/admin`）提供以下六大功能模組：

| 分頁 | 圖標 | 用途 | 目標用戶 |
|------|------|------|---------|
| 系統統計 | 📊 | 查看系統整體狀態和服務健康度 | 系統管理員 |
| 用戶管理 | 👥 | 管理用戶帳號、權限、會員等級 | 管理員 |
| 數據同步 | 🔄 | 管理數據同步任務（從外部 API 獲取） | 運維人員 |
| **數據處理** | **⚙️** | **管理數據處理任務（資料庫內計算）** | **運維人員** |
| 策略監控 | 🔔 | 監控實盤策略信號檢測 | 管理員 + 交易員 |
| 日誌查詢 | 📝 | 查詢系統日誌和錯誤記錄 | 開發人員 |

---

## 📦 任務三分類架構

### 關鍵概念

QuantLab 的 Celery 任務按照**數據流向**分為三大類：

| 分類 | 數據流向 | 定義 | 典型範例 |
|------|---------|------|---------|
| **🔄 數據同步** | External API → Database | 從外部 API 獲取原始數據並存入資料庫 | sync_daily_prices, sync_shioaji_top_stocks |
| **⚙️ 數據處理** | Database → Compute → Database/File | 從資料庫讀取數據，經過計算後存回資料庫或導出文件 | generate_continuous_contracts, cleanup_old_cache |
| **🔔 策略處理** | Database → Strategy Engine → Signals | 從資料庫讀取策略和市場數據，通過策略引擎生成信號 | monitor_active_strategies |

### 三分類對照表

| 比較項目 | 數據同步（🔄） | 數據處理（⚙️） | 策略處理（🔔） |
|---------|--------------|--------------|--------------|
| **核心功能** | 從外部 API 獲取並儲存數據 | 計算、轉換、清理已存數據 | 執行策略並檢測交易信號 |
| **數據來源** | FinLab API、Shioaji API | PostgreSQL 資料庫 | PostgreSQL 資料庫 |
| **數據流向** | 外部 → 資料庫 | 資料庫 → 計算 → 資料庫/文件 | 資料庫 → 策略引擎 → 信號 |
| **是否依賴外部 API** | ✅ 是 | ❌ 否 | ❌ 否 |
| **可否離線執行** | ❌ 否 | ✅ 是 | ✅ 是 |
| **冪等性** | ⚠️  部分（重複執行可能浪費配額） | ✅ 是（可重複執行） | ⚠️  部分（會產生重複通知） |
| **目標對象** | 資料庫（所有用戶共享） | 資料庫或文件系統 | 用戶（策略擁有者） |
| **輸出結果** | 股價、財報等數據表 | 連續合約、清理後的表 | 買入/賣出信號 + Telegram 通知 |

### 詳細說明

#### 🔄 數據同步（Data Sync）

**用途**：從外部 API 獲取最新數據，維護數據庫的時效性和完整性

**任務範例**（共 11 個）：
- ✅ `sync_daily_prices`: 從 FinLab API 同步每日股價（OHLCV）
- ✅ `sync_fundamental_data`: 同步財務報表數據
- ✅ `sync_shioaji_top_stocks`: 同步 Shioaji 分鐘線數據（所有股票）
- ✅ `sync_shioaji_futures`: 同步 Shioaji 期貨分鐘線（TX/MTX）
- ✅ `sync_option_daily_factors`: 同步選擇權因子（含即時計算）
- ✅ `sync_institutional_investors`: 同步法人買賣超數據

**執行流程**：
```
FinLab API / Shioaji API
         ↓
   Celery Worker 執行同步任務
         ↓
  寫入 PostgreSQL 資料庫
         ↓
   存入 Qlib 二進制（可選）
```

**特點**：
- ✅ 依賴外部 API（可能受速率限制）
- ✅ 對所有用戶共享（所有人看到相同數據）
- ✅ 失敗會記錄錯誤但不通知用戶
- ⚠️  重複執行可能浪費 API 配額

---

#### ⚙️ 數據處理（Data Processing）

**用途**：從資料庫讀取已存數據，經過計算、轉換後，存回資料庫或導出文件

**任務範例**（共 5 個）：
- ✅ `generate_continuous_contracts`: 從月份合約拼接為連續合約（TX → TXCONT）
- ✅ `register_new_futures_contracts`: 註冊新年度期貨合約（每年 1/1）
- ✅ `cleanup_old_cache`: 清理 Redis 過期快取
- ✅ `cleanup_old_institutional_data`: 清理舊法人數據（保留 365 天）
- ✅ `cleanup_old_signals`: 清理舊信號記錄（保留 30 天）

**執行流程**：
```
從 PostgreSQL 讀取數據
         ↓
  執行計算或轉換邏輯
         ↓
寫回 PostgreSQL 或導出 Qlib 文件
```

**特點**：
- ✅ 不依賴外部 API（可離線執行）
- ✅ 冪等性（可安全重複執行）
- ✅ 純內部處理（不涉及外部通信）
- ✅ 確保數據一致性和完整性

---

#### 🔔 策略處理（Strategy Processing）

**用途**：實盤監控用戶的 ACTIVE 策略，檢測買賣信號並通知

**任務範例**：
- ✅ `monitor_active_strategies`: 每 15 分鐘檢測所有 ACTIVE 策略
- ✅ `cleanup_old_signals`: 清理 30 天前的舊信號記錄

**執行流程**：
```
查詢 ACTIVE 策略列表
         ↓
從 PostgreSQL 讀取歷史數據（最近 60 天）
         ↓
   執行策略邏輯（Backtrader）
         ↓
   檢測買入/賣出信號
         ↓
過濾重複信號（15 分鐘內相同方向）
         ↓
   存入 strategy_signals 表
         ↓
發送 Telegram 通知給策略擁有者
```

**特點**：
- 只處理用戶標記為 ACTIVE 的策略
- 每個用戶只收到自己策略的信號（隱私保護）
- 需要策略配置 `stocks` 參數
- 發送個人化通知

---

### 實際案例對比

#### 案例 1: 股價數據不是最新的

**問題場景**：
> 用戶發現策略回測使用的股價數據停留在一週前

**解決方式**：
- ❌ **錯誤**：去「策略監控」分頁檢查
- ✅ **正確**：去「數據同步」分頁，手動執行 `sync_daily_prices` 任務

**原因**：
- 股價數據由「數據同步」任務負責更新
- 「策略監控」只讀取現有數據，不更新數據

---

#### 案例 2: 策略沒有收到交易信號

**問題場景**：
> 用戶將策略設為 ACTIVE，但沒有收到任何 Telegram 通知

**解決方式**：
- ❌ **錯誤**：去「數據同步」分頁檢查
- ✅ **正確**：去「策略監控」分頁，檢查：
  1. 監控任務是否正常執行
  2. 策略是否配置了 `stocks` 參數
  3. 查看最新信號記錄

**原因**：
- 交易信號由「策略監控」任務檢測
- 「數據同步」與信號檢測無關

---

#### 案例 3: 分鐘線數據缺失

**問題場景**：
> 期貨策略回測報錯「找不到 TX 分鐘線數據」

**解決方式**：
- ❌ **錯誤**：去「策略監控」分頁
- ✅ **正確**：去「數據同步」分頁，手動執行 `sync_shioaji_futures` 任務

**原因**：
- 分鐘線數據由 Shioaji 同步任務獲取
- 「策略監控」不負責數據獲取

---

## 📚 各分頁功能說明

### 1️⃣ 系統統計（📊）

**功能**：
- 查看系統整體統計（用戶數、策略數、回測數）
- 檢查服務健康狀態（資料庫、Redis、Celery）
- 監控系統資源使用情況

**適用場景**：
- 系統管理員日常檢查
- 排查系統性能問題
- 監控服務可用性

---

### 2️⃣ 用戶管理（👥）

**功能**：
- 查看所有用戶列表（可排序）
- 編輯用戶資料（會員等級、現金、信用）
- 管理用戶權限（管理員、啟用/停用）
- 查看用戶 Telegram 綁定狀態

**新功能**：
- ✅ 點擊表頭圖標可排序（ID、用戶名、會員等級等）
- ✅ 支援升序/降序切換

**適用場景**：
- 調整用戶會員等級
- 處理用戶帳號問題
- 查看用戶註冊和登入記錄

---

### 3️⃣ 數據同步（🔄）

**功能**：
- 查看所有數據同步任務的執行狀態
- 手動觸發同步任務
- 查看任務執行歷史和錯誤訊息
- 監控 Celery Worker 狀態

**任務分類**：

| 任務類別 | 任務範例 | 執行頻率 |
|---------|---------|---------|
| 股價數據 | `sync_daily_prices` | 每日 21:00 |
| 分鐘線數據 | `sync_shioaji_top_stocks` | 每日 15:00 |
| 期貨數據 | `sync_shioaji_futures` | 每日 15:30 |
| 財報數據 | `sync_fundamental_latest` | 每日 23:00 |
| 法人數據 | `sync_top_stocks_institutional` | 每日 21:00 |

**適用場景**：
- 股價數據異常時手動補同步
- 檢查數據更新是否正常
- 排查數據缺失問題

---

### 4️⃣ 策略監控（🔔）

**功能**：
- 查看策略監控任務的執行狀態
- 查看監控統計（今日信號數、ACTIVE 策略數）
- 查看最新檢測到的交易信號
- 手動觸發監控任務

**重要提醒**：
⚠️ 策略必須滿足以下條件才會被監控：
1. 策略狀態為 `ACTIVE`
2. 引擎類型為 `backtrader`（Qlib 引擎暫不支援）
3. `parameters` 中必須配置 `stocks` 陣列

**範例配置**：
```json
{
  "stocks": ["2330", "2317", "2454"],
  "short_period": 5,
  "long_period": 20
}
```

**監控時段**：
- 股票交易時段：09:00-13:00（每 15 分鐘）
- 期貨夜盤時段：15:00-05:00（每 15 分鐘）

**適用場景**：
- 檢查策略是否正常監控
- 查看最新交易信號
- 驗證 Telegram 通知是否發送

---

### 5️⃣ 日誌查詢（📝）

**功能**：
- 查詢系統日誌（支援級別篩選）
- 搜尋特定關鍵字
- 查看錯誤訊息詳情

**適用場景**：
- 排查系統錯誤
- 追蹤任務執行細節
- 開發和除錯

---

## ❓ 常見問題

### Q1: 為什麼策略監控任務顯示「尚未執行」？

**答**：有兩種可能：

1. **任務確實有執行，但沒有 ACTIVE 策略需要監控**
   - 檢查方式：查看 Celery Worker 日誌
   - 解決方式：確保至少有一個策略狀態為 ACTIVE 且配置了 stocks

2. **API 未正確記錄執行狀態**
   - 這是已知問題，任務實際有執行但 Redis 快取未更新
   - 不影響功能，只是顯示問題

### Q2: 數據同步失敗怎麼辦？

**答**：
1. 查看「數據同步」分頁的錯誤訊息
2. 檢查 API Token 是否有效（FinLab、Shioaji）
3. 查看 Celery Worker 日誌：
   ```bash
   docker compose logs celery-worker | grep ERROR
   ```
4. 手動觸發任務重試

### Q3: 策略監控沒有檢測到信號？

**答**：檢查以下項目：
1. ✅ 策略狀態是否為 ACTIVE
2. ✅ 策略 `parameters` 是否配置了 `stocks`
3. ✅ 引擎類型是否為 `backtrader`（Qlib 不支援）
4. ✅ 當前時間是否在監控時段（09:00-13:00 或 15:00-05:00）
5. ✅ 策略邏輯是否真的產生信號

**診斷工具**：
```bash
bash /home/ubuntu/QuantLab/test_strategy_monitoring.sh
```

### Q4: 如何區分數據問題和策略問題？

**決策樹**：

```
問題：回測結果異常
         ↓
    數據是否最新？
    ├── 否 → 去「數據同步」執行同步任務
    └── 是 → 去「策略監控」檢查策略配置
```

**口訣**：
- 數據不對 → 數據同步
- 信號不對 → 策略監控

---

## 📖 相關文檔

- [CLAUDE.md](CLAUDE.md) - 完整開發指南
- [STRATEGY_MONITORING_GUIDE.md](STRATEGY_MONITORING_GUIDE.md) - 策略監控功能詳解
- [DATA_SYNC_SCHEDULE.md](DATA_SYNC_SCHEDULE.md) - 數據同步排程表

---

**文檔版本**: 1.0
**維護者**: 開發團隊
**最後更新**: 2025-12-16
